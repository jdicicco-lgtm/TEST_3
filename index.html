<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Flotta & Prenotazioni</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #f3f4f6;
    }
    .kpi-card {
      border-radius: 1rem;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
    }
    .kpi-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #6b7280;
    }
    .kpi-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: #111827;
    }
    .kpi-prev {
      font-size: 0.72rem;
      color: #9ca3af;
    }
    .kpi-delta-pos {
      color: #16a34a;
      font-weight: 600;
    }
    .kpi-delta-neg {
      color: #dc2626;
      font-weight: 600;
    }
    .sidebar {
      position: sticky;
      top: 1rem;
    }
    .chart-container {
      position: relative;
      height: 420px;
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="bg-white border-bottom mb-3">
    <div class="container-fluid py-3 px-3 px-md-4 d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h4 mb-1">Dashboard Flotta &amp; Prenotazioni üöóüìä</h1>
        <div class="text-muted small">
          Analisi 2024‚Äì2026 ¬∑ Flotta, Costi &amp; Revenue (con proiezioni)
        </div>
      </div>
      <span class="badge rounded-pill text-bg-success">
        Static HTML ¬∑ JSON ¬∑ GitHub Pages
      </span>
    </div>
  </header>

  <main class="container-fluid pb-4 px-3 px-md-4">
    <div class="row g-3">
      <!-- SIDEBAR FILTRI -->
      <aside class="col-lg-3">
        <div class="sidebar">
          <div class="card kpi-card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h6 mb-0">Filtri üéõÔ∏è</h2>
                <button id="resetFiltersBtn" class="btn btn-sm btn-outline-secondary">
                  Pulisci filtri
                </button>
              </div>

              <div class="accordion" id="filtersAccordion">
                <!-- Anno -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingYear">
                    <button class="accordion-button py-2 collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseYear">
                      Anno
                    </button>
                  </h2>
                  <div id="collapseYear" class="accordion-collapse collapse"
                       data-bs-parent="#filtersAccordion">
                    <div class="accordion-body py-2">
                      <select id="yearFilter" class="form-select form-select-sm" multiple></select>
                      <div class="form-text small">Multi-selezione (2024‚Äì2026)</div>
                    </div>
                  </div>
                </div>

                <!-- Mese -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingMonth">
                    <button class="accordion-button py-2 collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseMonth">
                      Mese
                    </button>
                  </h2>
                  <div id="collapseMonth" class="accordion-collapse collapse"
                       data-bs-parent="#filtersAccordion">
                    <div class="accordion-body py-2">
                      <select id="monthFilter" class="form-select form-select-sm" multiple></select>
                      <div class="form-text small">Gennaio‚ÄìDicembre</div>
                    </div>
                  </div>
                </div>

                <!-- Tipologia -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingTipo">
                    <button class="accordion-button py-2 collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseTipo">
                      Tipologia
                    </button>
                  </h2>
                  <div id="collapseTipo" class="accordion-collapse collapse"
                       data-bs-parent="#filtersAccordion">
                    <div class="accordion-body py-2">
                      <select id="tipoFilter" class="form-select form-select-sm" multiple></select>
                    </div>
                  </div>
                </div>

                <!-- Gruppo veicolo -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingGruppo">
                    <button class="accordion-button py-2 collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseGruppo">
                      Gruppo veicolo
                    </button>
                  </h2>
                  <div id="collapseGruppo" class="accordion-collapse collapse"
                       data-bs-parent="#filtersAccordion">
                    <div class="accordion-body py-2">
                      <select id="gruppoFilter" class="form-select form-select-sm" multiple></select>
                    </div>
                  </div>
                </div>

                <!-- Acquisizione -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingAcq">
                    <button class="accordion-button py-2 collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseAcq">
                      Acquisizione
                    </button>
                  </h2>
                  <div id="collapseAcq" class="accordion-collapse collapse"
                       data-bs-parent="#filtersAccordion">
                    <div class="accordion-body py-2">
                      <select id="acquisizioneFilter" class="form-select form-select-sm" multiple></select>
                    </div>
                  </div>
                </div>

                <!-- Stazione -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingStation">
                    <button class="accordion-button py-2 collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseStation">
                      Stazione
                    </button>
                  </h2>
                  <div id="collapseStation" class="accordion-collapse collapse"
                       data-bs-parent="#filtersAccordion">
                    <div class="accordion-body py-2">
                      <select id="stazioneFilter" class="form-select form-select-sm" multiple></select>
                    </div>
                  </div>
                </div>

                <!-- Proiezione 2026 -->
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingProj">
                    <button class="accordion-button py-2 collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseProj">
                      Proiezione 2026 üîÆ
                    </button>
                  </h2>
                  <div id="collapseProj" class="accordion-collapse collapse"
                       data-bs-parent="#filtersAccordion">
                    <div class="accordion-body py-2">
                      <select id="projectionSelect" class="form-select form-select-sm">
                        <option value="0.05">+5%</option>
                        <option value="0.10" selected>+10% (default)</option>
                        <option value="0.15">+15%</option>
                        <option value="0.20">+20%</option>
                      </select>
                      <div class="form-text small">
                        Applicata alle prenotazioni proiettate Feb‚ÄìDic 2026.
                      </div>
                    </div>
                  </div>
                </div>
              </div> <!-- accordion -->
            </div>
          </div>
        </div>
      </aside>

      <!-- CONTENUTO PRINCIPALE -->
      <section class="col-lg-9">
        <!-- KPI CARDS -->
        <div class="row g-3 mb-3">
          <!-- Dimensione Flotta -->
          <div class="col-md-6 col-xl-3">
            <div class="card kpi-card h-100">
              <div class="card-body">
                <div class="kpi-label mb-1">üöó Dimensione Flotta (media)</div>
                <div id="kpiFleetSize" class="kpi-value">-</div>
                <div id="kpiFleetSizePrev" class="kpi-prev mt-1"></div>
              </div>
            </div>
          </div>

          <!-- Canone Imponibile -->
          <div class="col-md-6 col-xl-3">
            <div class="card kpi-card h-100">
              <div class="card-body">
                <div class="kpi-label mb-1">üí∂ Canone Imponibile</div>
                <div id="kpiCanone" class="kpi-value">-</div>
                <div id="kpiCanonePrev" class="kpi-prev mt-1"></div>
              </div>
            </div>
          </div>

          <!-- Canone Totale IVATO -->
          <div class="col-md-6 col-xl-3">
            <div class="card kpi-card h-100">
              <div class="card-body">
                <div class="kpi-label mb-1">üí∂ Canone Totale (IVATO)</div>
                <div id="kpiCanoneIvato" class="kpi-value">-</div>
                <div class="kpi-prev mt-1">
                  Calcolato con IVA 22% su Canone Imponibile.
                </div>
              </div>
            </div>
          </div>

          <!-- Assicurazione -->
          <div class="col-md-6 col-xl-3">
            <div class="card kpi-card h-100">
              <div class="card-body">
                <div class="kpi-label mb-1">üõ°Ô∏è Assicurazione</div>
                <div id="kpiAssicurazione" class="kpi-value">-</div>
                <div id="kpiAssicurazionePrev" class="kpi-prev mt-1"></div>
              </div>
            </div>
          </div>

          <!-- Costo Totale -->
          <div class="col-md-6 col-xl-3">
            <div class="card kpi-card h-100">
              <div class="card-body">
                <div class="kpi-label mb-1">üí∞ Costo Totale</div>
                <div id="kpiCostoTotale" class="kpi-value">-</div>
                <div id="kpiCostoTotalePrev" class="kpi-prev mt-1"></div>
              </div>
            </div>
          </div>

          <!-- Revenue -->
          <div class="col-md-6 col-xl-3">
            <div class="card kpi-card h-100">
              <div class="card-body">
                <div class="kpi-label mb-1">üí∏ Revenue</div>
                <div id="kpiRevenue" class="kpi-value">-</div>
                <div id="kpiRevenuePrev" class="kpi-prev mt-1"></div>
              </div>
            </div>
          </div>

          <!-- Revenue per Day -->
          <div class="col-md-6 col-xl-3">
            <div class="card kpi-card h-100">
              <div class="card-body">
                <div class="kpi-label mb-1">‚òÄÔ∏è Revenue per Day</div>
                <div id="kpiRevenuePerDay" class="kpi-value">-</div>
                <div id="kpiRevenuePerDayPrev" class="kpi-prev mt-1"></div>
              </div>
            </div>
          </div>

          <!-- Numero Prenotazioni -->
          <div class="col-md-6 col-xl-3">
            <div class="card kpi-card h-100">
              <div class="card-body">
                <div class="kpi-label mb-1">üìù Numero Prenotazioni</div>
                <div id="kpiNumPren" class="kpi-value">-</div>
                <div id="kpiNumPrenPrev" class="kpi-prev mt-1"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- BLOCCO PROIEZIONI / PRENOTAZIONI GEN 2026 -->
        <div class="card kpi-card mb-3 bg-dark text-light">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h2 class="h6 mb-0">PROIEZIONI 2026 &amp; DATI EFFETTIVI üî≠</h2>
              <span class="small text-secondary">
                Gennaio 2026 = dati reali (no proiezione %)
              </span>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <div class="border rounded-3 p-3 bg-black bg-opacity-25">
                  <div class="kpi-label mb-1 text-light">
                    ‚úÖ Prenotazioni Effettive (Gennaio 2026)
                  </div>
                  <div id="kpiPrenGen2026" class="kpi-value text-light">-</div>
                  <div class="kpi-prev mt-1">
                    Filtrate per gruppi/stazioni selezionati (no % proiezione).
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- GRAFICO -->
        <div class="card kpi-card">
          <div class="card-body">
            <div class="kpi-label mb-1">
              Andamento Flotta, Costo Totale e Revenue per mese
            </div>
            <div class="chart-container">
              <canvas id="mainChart"></canvas>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ================== DATI IN MEMORIA ==================
    let fleetData = [];
    let fleetStations2025 = [];
    let bookings2025 = [];
    let bookingsJan2026 = [];

    const monthNames = [
      "Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
      "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"
    ];

    // ================== HELPER ==================
    function parseISO(dateStr) {
      return new Date(dateStr + "T00:00:00");
    }
    function getYear(d) { return d.getFullYear(); }
    function getMonth(d) { return d.getMonth() + 1; }

    function formatCurrency(value) {
      if (value == null || isNaN(value)) return "-";
      return value.toLocaleString("it-IT", {
        style: "currency",
        currency: "EUR",
        maximumFractionDigits: 0
      });
    }

    function formatNumber(value, decimals = 0) {
      if (value == null || isNaN(value)) return "-";
      return value.toLocaleString("it-IT", {
        maximumFractionDigits: decimals,
        minimumFractionDigits: decimals
      });
    }

    function normalizeKey(val) {
      if (val === null || val === undefined) return "";
      const s = String(val).trim();
      if (!s || s.toUpperCase() === "NAN") return "";
      return s.toUpperCase();
    }

    function normalizeLabel(val) {
      if (val === null || val === undefined) return "";
      const s = String(val).trim();
      if (!s || s.toUpperCase() === "NAN") return "";
      return s;
    }

    function detectColumn(obj, candidatesNormalized) {
      if (!obj) return null;
      const keys = Object.keys(obj);
      for (const key of keys) {
        const norm = key.toLowerCase().replace(/\s+/g, "");
        if (candidatesNormalized.includes(norm)) return key;
      }
      return null;
    }

    async function loadJsonClean(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("Errore nel caricamento di " + url);
      let text = await res.text();
      text = text.replace(/\bNaN\b/g, "0");
      return JSON.parse(text);
    }

    // ================== PROIEZIONI BOOKING ==================
    function generateAllBookings(projectionFactor) {
      const all = [];

      bookings2025.forEach((b) => {
        const d2025 = parseISO(b.startDate);
        const year2025 = getYear(d2025);
        const month = getMonth(d2025);

        // 2025 reale
        all.push({ ...b, year: year2025, month });

        // 2024 = -5%
        const d2024 = new Date(d2025);
        d2024.setFullYear(year2025 - 1);
        all.push({
          ...b,
          year: getYear(d2024),
          month: getMonth(d2024),
          startDate: d2024.toISOString().slice(0, 10),
          price: (b.price || 0) * 0.95
        });

        // 2026 (escluso Gennaio)
        const d2026 = new Date(d2025);
        d2026.setFullYear(year2025 + 1);
        const m2026 = getMonth(d2026);
        if (m2026 !== 1) {
          all.push({
            ...b,
            year: getYear(d2026),
            month: m2026,
            startDate: d2026.toISOString().slice(0, 10),
            price: (b.price || 0) * (1 + projectionFactor)
          });
        }
      });

      // Gennaio 2026 reale
      bookingsJan2026.forEach((b) => {
        const d = parseISO(b.startDate);
        all.push({ ...b, year: getYear(d), month: getMonth(d) });
      });

      return all;
    }

    // ================== POPOLAMENTO FILTRI ==================
    function populateFilterOptions(allFleet, allBookings, stationsData) {
      const yearSel  = document.getElementById("yearFilter");
      const monthSel = document.getElementById("monthFilter");
      const tipoSel  = document.getElementById("tipoFilter");
      const gruppoSel= document.getElementById("gruppoFilter");
      const acqSel   = document.getElementById("acquisizioneFilter");
      const statSel  = document.getElementById("stazioneFilter");

      [yearSel,monthSel,tipoSel,gruppoSel,acqSel,statSel].forEach(sel => sel.innerHTML = "");

      // Anni 2024-2026
      const years = new Set();
      allFleet.forEach(f => years.add(f.year));
      allBookings.forEach(b => years.add(b.year));
      stationsData.forEach(s => years.add(s.year));

      Array.from(years)
        .filter(y => y >= 2024 && y <= 2026)
        .sort()
        .forEach(y => {
          const opt = document.createElement("option");
          opt.value = String(y);
          opt.textContent = String(y);
          yearSel.appendChild(opt);
        });

      // Mesi 1-12
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement("option");
        opt.value = String(m);
        opt.textContent = monthNames[m-1];
        monthSel.appendChild(opt);
      }

      // Tipologia (fallback su gruppo se non presente)
      const tipoMap = new Map();
      allFleet.forEach(f => {
        if (!f.tipoKey && f.gruppoKey) {
          f.tipoKey   = f.gruppoKey;
          f.tipoLabel = f.gruppoLabel;
        }
        if (f.tipoKey && !tipoMap.has(f.tipoKey)) {
          tipoMap.set(f.tipoKey, f.tipoLabel || f.tipoKey);
        }
      });
      allBookings.forEach(b => {
        if (!b.tipoKey && b.gruppoKey) {
          b.tipoKey   = b.gruppoKey;
          b.tipoLabel = b.gruppoLabel;
        }
        if (b.tipoKey && !tipoMap.has(b.tipoKey)) {
          tipoMap.set(b.tipoKey, b.tipoLabel || b.tipoKey);
        }
      });

      Array.from(tipoMap.entries())
        .sort((a,b) => a[1].localeCompare(b[1],"it"))
        .forEach(([key,label]) => {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = label;
          tipoSel.appendChild(opt);
        });

      // Gruppo (fonte principale: fleetStations2025)
      const groupMap = new Map();
      stationsData.forEach(s => {
        if (s.groupKey && !groupMap.has(s.groupKey)) {
          groupMap.set(s.groupKey, s.groupLabel || s.groupKey);
        }
      });
      allFleet.forEach(f => {
        if (f.gruppoKey && !groupMap.has(f.gruppoKey)) {
          groupMap.set(f.gruppoKey, f.gruppoLabel || f.gruppoKey);
        }
      });
      allBookings.forEach(b => {
        if (b.gruppoKey && !groupMap.has(b.gruppoKey)) {
          groupMap.set(b.gruppoKey, b.gruppoLabel || b.gruppoKey);
        }
      });

      Array.from(groupMap.entries())
        .sort((a,b) => a[1].localeCompare(b[1],"it"))
        .forEach(([key,label]) => {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = label;
          gruppoSel.appendChild(opt);
        });

      // Acquisizione
      const acqMap = new Map();
      allFleet.forEach(f => {
        if (f.acqKey && !acqMap.has(f.acqKey)) {
          acqMap.set(f.acqKey, f.acqLabel || f.acqKey);
        }
      });
      allBookings.forEach(b => {
        if (b.acqKey && !acqMap.has(b.acqKey)) {
          acqMap.set(b.acqKey, b.acqLabel || b.acqKey);
        }
      });

      Array.from(acqMap.entries())
        .sort((a,b) => a[1].localeCompare(b[1],"it"))
        .forEach(([key,label]) => {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = label;
          acqSel.appendChild(opt);
        });

      // Stazione
      const statMap = new Map();
      stationsData.forEach(s => {
        if (s.stationKey && !statMap.has(s.stationKey)) {
          statMap.set(s.stationKey, s.stationLabel || s.stationKey);
        }
      });
      allFleet.forEach(f => {
        if (f.stationKey && !statMap.has(f.stationKey)) {
          statMap.set(f.stationKey, f.stationLabel || f.stationKey);
        }
      });
      allBookings.forEach(b => {
        if (b.stationKey && !statMap.has(b.stationKey)) {
          statMap.set(b.stationKey, b.stationLabel || b.stationKey);
        }
      });

      Array.from(statMap.entries())
        .sort((a,b) => a[1].localeCompare(b[1],"it"))
        .forEach(([key,label]) => {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = label;
          statSel.appendChild(opt);
        });

      // selezione completa di default
      [yearSel,monthSel,tipoSel,gruppoSel,acqSel,statSel].forEach(sel => {
        for (let i=0; i<sel.options.length; i++) sel.options[i].selected = true;
      });
    }

    function getMultiSelectValues(id) {
      const sel = document.getElementById(id);
      const vals = [];
      for (let i=0; i<sel.options.length; i++) {
        if (sel.options[i].selected) vals.push(sel.options[i].value);
      }
      return vals;
    }

    // ================== RANGE PERIODI ==================
    function getCurrentAndPreviousRanges(filters) {
      const { years, months } = filters;

      const allYears  = years.length ? years.map(y => parseInt(y,10)) : [2024,2025,2026];
      const allMonths = months.length ? months.map(m => parseInt(m,10)) : [1,12];

      const minYear  = Math.min(...allYears);
      const maxYear  = Math.max(...allYears);
      const minMonth = Math.min(...allMonths);
      const maxMonth = Math.max(...allMonths);

      const startCurrent = new Date(minYear, minMonth-1, 1);
      const endCurrent   = new Date(maxYear, maxMonth, 0);

      const diffMonths =
        (endCurrent.getFullYear() - startCurrent.getFullYear()) * 12 +
        (endCurrent.getMonth() - startCurrent.getMonth()) + 1;

      const endPrev = new Date(startCurrent);
      endPrev.setMonth(endPrev.getMonth() - 1);
      const startPrev = new Date(endPrev);
      startPrev.setMonth(startPrev.getMonth() - (diffMonths-1));
      startPrev.setDate(1);
      endPrev.setDate(new Date(endPrev.getFullYear(), endPrev.getMonth()+1, 0).getDate());

      return {
        current : { start: startCurrent, end: endCurrent },
        previous: { start: startPrev,    end: endPrev }
      };
    }

    function filterDataForRange(allFleet, allBookings, stationsData, filters, rangeKey) {
      const range = rangeKey === "current" ? filters.currentRange : filters.previousRange;
      const applyYearMonth = (rangeKey === "current");

      const fleet = allFleet.filter(f => {
        const d = f.refDateObj;
        const year = f.year;
        const month= f.month;

        if (applyYearMonth) {
          if (filters.years.length && !filters.years.includes(String(year))) return false;
          if (filters.months.length && !filters.months.includes(String(month))) return false;
        }
        if (filters.tipiKeys.length && f.tipoKey    && !filters.tipiKeys.includes(f.tipoKey)) return false;
        if (filters.groupKeys.length && f.gruppoKey && !filters.groupKeys.includes(f.gruppoKey)) return false;
        if (filters.acqKeys.length   && f.acqKey    && !filters.acqKeys.includes(f.acqKey))   return false;
        if (filters.stationKeys.length && f.stationKey && !filters.stationKeys.includes(f.stationKey)) return false;

        return d >= range.start && d <= range.end;
      });

      const bookings = allBookings.filter(b => {
        const d = parseISO(b.startDate);
        const year = b.year;
        const month= b.month;

        if (applyYearMonth) {
          if (filters.years.length && !filters.years.includes(String(year))) return false;
          if (filters.months.length && !filters.months.includes(String(month))) return false;
        }
        if (filters.tipiKeys.length && b.tipoKey    && !filters.tipiKeys.includes(b.tipoKey)) return false;
        if (filters.groupKeys.length && b.gruppoKey && !filters.groupKeys.includes(b.gruppoKey)) return false;
        if (filters.acqKeys.length   && b.acqKey    && !filters.acqKeys.includes(b.acqKey))   return false;
        if (filters.stationKeys.length && b.stationKey && !filters.stationKeys.includes(b.stationKey)) return false;

        return d >= range.start && d <= range.end;
      });

      const stations = stationsData.filter(s => {
        const d = s.dateObj;
        const year = s.year;
        const month= s.month;

        if (applyYearMonth) {
          if (filters.years.length && !filters.years.includes(String(year))) return false;
          if (filters.months.length && !filters.months.includes(String(month))) return false;
        }
        if (filters.groupKeys.length && s.groupKey   && !filters.groupKeys.includes(s.groupKey))   return false;
        if (filters.stationKeys.length && s.stationKey && !filters.stationKeys.includes(s.stationKey)) return false;

        return d >= range.start && d <= range.end;
      });

      return { fleet, bookings, stations };
    }

    // ================== KPI ==================
    function computeKpiForRange(fleet, bookings, stations) {
      // costi
      const sumCanone = fleet.reduce((acc,f) => acc + (f.canoneImponibile || 0), 0);
      const sumAss    = fleet.reduce((acc,f) => acc + (f.assicurazione   || 0), 0);
      const costoTot  = sumCanone + sumAss;
      const canoneIvato = sumCanone * 1.22;

      // flotta media usando stations (fallback: conta veicoli se manca)
      const monthlyCounts = {};
      stations.forEach(s => {
        const key = `${s.year}-${String(s.month).padStart(2,"0")}`;
        monthlyCounts[key] = (monthlyCounts[key] || 0) + (s.fleet || 0);
      });
      fleet.forEach(f => {
        const key = `${f.year}-${String(f.month).padStart(2,"0")}`;
        if (!(key in monthlyCounts)) {
          monthlyCounts[key] = (monthlyCounts[key] || 0) + 1;
        }
      });
      const values = Object.values(monthlyCounts);
      const fleetSize = values.length ? values.reduce((a,b)=>a+b,0) / values.length : 0;

      // revenue
      const sumRevenue  = bookings.reduce((acc,b)=>acc + (b.price || 0), 0);
      const sumDuration = bookings.reduce((acc,b)=>acc + (b.duration || 0), 0);
      const revenuePerDay = sumDuration > 0 ? sumRevenue / sumDuration : null;
      const numPren = bookings.length;

      return {
        fleetSize,
        canone: sumCanone,
        canoneIvato,
        assicurazione: sumAss,
        costoTotale: costoTot,
        revenue: sumRevenue,
        revenuePerDay,
        numPren
      };
    }

    function computeJan2026Kpi(filters) {
      const bookings = bookingsJan2026.filter(b => {
        if (filters.tipiKeys.length && b.tipoKey    && !filters.tipiKeys.includes(b.tipoKey)) return false;
        if (filters.groupKeys.length && b.gruppoKey && !filters.groupKeys.includes(b.gruppoKey)) return false;
        if (filters.acqKeys.length   && b.acqKey    && !filters.acqKeys.includes(b.acqKey))   return false;
        if (filters.stationKeys.length && b.stationKey && !filters.stationKeys.includes(b.stationKey)) return false;
        return true;
      });
      return bookings.length;
    }

    function buildPrevText(labelPrev, currVal, prevVal, isCurrency=false, decimals=1) {
      if (prevVal == null || isNaN(prevVal)) {
        return labelPrev + ": -";
      }
      const diff = currVal - prevVal;
      let pct   = null;
      if (prevVal !== 0) {
        pct = (diff / prevVal) * 100;
      }

      const baseLabel = labelPrev + ": " + (isCurrency ? formatCurrency(prevVal) : formatNumber(prevVal, decimals));
      if (pct === null) return baseLabel + " (Œî n/d)";
      const pctStr = formatNumber(Math.abs(pct), 1) + "%";
      const sign = pct > 0 ? "+" : pct < 0 ? "‚àí" : "¬±0%";
      const cls  = pct > 0 ? "kpi-delta-pos" : pct < 0 ? "kpi-delta-neg" : "";
      return `${baseLabel} ¬∑ <span class="${cls}">${sign === "¬±0%" ? sign : sign + pctStr}</span>`;
    }

    // ================== GRAFICO ==================
    let mainChart = null;

    function updateChart(allFleet, allBookings, stationsData, filters) {
      const { fleet, bookings, stations } = filterDataForRange(
        allFleet, allBookings, stationsData, filters, "current"
      );

      const buckets = {};

      stations.forEach(s => {
        const key = `${s.year}-${String(s.month).padStart(2,"0")}`;
        if (!buckets[key]) {
          buckets[key] = { fleet: 0, costo: 0, revenue: 0 };
        }
        buckets[key].fleet += (s.fleet || 0);
      });

      fleet.forEach(f => {
        const key = `${f.year}-${String(f.month).padStart(2,"0")}`;
        if (!buckets[key]) {
          buckets[key] = { fleet: 0, costo: 0, revenue: 0 };
        }
        if (buckets[key].fleet === 0) buckets[key].fleet += 1;
        buckets[key].costo += (f.canoneImponibile || 0) + (f.assicurazione || 0);
      });

      bookings.forEach(b => {
        const key = `${b.year}-${String(b.month).padStart(2,"0")}`;
        if (!buckets[key]) {
          buckets[key] = { fleet: 0, costo: 0, revenue: 0 };
        }
        buckets[key].revenue += (b.price || 0);
      });

      const labels = Object.keys(buckets).sort();
      const fleetSeries = labels.map(k => buckets[k].fleet);
      const costoSeries = labels.map(k => buckets[k].costo);
      const revSeries   = labels.map(k => buckets[k].revenue);

      const ctx = document.getElementById("mainChart").getContext("2d");
      if (mainChart) mainChart.destroy();

      mainChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Flotta (veicoli)",
              data: fleetSeries,
              borderWidth: 2,
              tension: 0.25,
              yAxisID: "y",
            },
            {
              label: "Costo Totale (‚Ç¨)",
              data: costoSeries,
              borderWidth: 2,
              tension: 0.25,
              yAxisID: "y1",
            },
            {
              label: "Revenue (‚Ç¨)",
              data: revSeries,
              borderWidth: 2,
              borderDash: [5,5],
              tension: 0.25,
              yAxisID: "y1",
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "index",
            intersect: false
          },
          plugins: {
            tooltip: {
              callbacks: {
                title: (items) => {
                  if (!items.length) return "";
                  const [y,m] = items[0].label.split("-");
                  return `${monthNames[parseInt(m,10)-1]} ${y}`;
                },
                label: (item) => {
                  const label = item.dataset.label || "";
                  if (label.includes("Flotta")) {
                    return `${label}: ${formatNumber(item.parsed.y,0)} veicoli`;
                  } else {
                    return `${label}: ${formatCurrency(item.parsed.y)}`;
                  }
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                callback: function(value) {
                  const label = this.getLabelForValue(value);
                  const [y,m] = label.split("-");
                  return `${monthNames[parseInt(m,10)-1].slice(0,3)} ${y}`;
                }
              }
            },
            y: {
              position: "left",
              title: { display: true, text: "Flotta (veicoli)" },
              beginAtZero: true
            },
            y1: {
              position: "right",
              title: { display: true, text: "‚Ç¨" },
              grid: { drawOnChartArea: false },
              beginAtZero: true
            }
          }
        }
      });
    }

    // ================== UPDATE DASHBOARD ==================
    function updateDashboard() {
      const projectionFactor = parseFloat(
        document.getElementById("projectionSelect").value
      );
      const allBookings = generateAllBookings(projectionFactor);

      const years      = getMultiSelectValues("yearFilter");
      const months     = getMultiSelectValues("monthFilter");
      const tipiKeys   = getMultiSelectValues("tipoFilter");
      const groupKeys  = getMultiSelectValues("gruppoFilter");
      const acqKeys    = getMultiSelectValues("acquisizioneFilter");
      const stationKeys= getMultiSelectValues("stazioneFilter");

      const ranges = getCurrentAndPreviousRanges({ years, months });

      const filters = {
        years,
        months,
        tipiKeys,
        groupKeys,
        acqKeys,
        stationKeys,
        currentRange: ranges.current,
        previousRange: ranges.previous
      };

      const current  = filterDataForRange(fleetData, allBookings, fleetStations2025, filters, "current");
      const previous = filterDataForRange(fleetData, allBookings, fleetStations2025, filters, "previous");

      const kCurr = computeKpiForRange(current.fleet, current.bookings, current.stations);
      const kPrev = computeKpiForRange(previous.fleet, previous.bookings, previous.stations);

      // KPI principali
      document.getElementById("kpiFleetSize").textContent      = formatNumber(kCurr.fleetSize,1);
      document.getElementById("kpiCanone").textContent         = formatCurrency(kCurr.canone);
      document.getElementById("kpiCanoneIvato").textContent    = formatCurrency(kCurr.canoneIvato);
      document.getElementById("kpiAssicurazione").textContent  = formatCurrency(kCurr.assicurazione);
      document.getElementById("kpiCostoTotale").textContent    = formatCurrency(kCurr.costoTotale);
      document.getElementById("kpiRevenue").textContent        = formatCurrency(kCurr.revenue);
      document.getElementById("kpiRevenuePerDay").textContent  = formatNumber(kCurr.revenuePerDay,2);
      document.getElementById("kpiNumPren").textContent        = formatNumber(kCurr.numPren,0);

      // KPI periodi precedenti con % Œî
      document.getElementById("kpiFleetSizePrev").innerHTML =
        buildPrevText("Periodo precedente", kCurr.fleetSize, kPrev.fleetSize, false, 1);

      document.getElementById("kpiCanonePrev").innerHTML =
        buildPrevText("Periodo precedente", kCurr.canone, kPrev.canone, true);

      document.getElementById("kpiAssicurazionePrev").innerHTML =
        buildPrevText("Periodo precedente", kCurr.assicurazione, kPrev.assicurazione, true);

      document.getElementById("kpiCostoTotalePrev").innerHTML =
        buildPrevText("Periodo precedente", kCurr.costoTotale, kPrev.costoTotale, true);

      document.getElementById("kpiRevenuePrev").innerHTML =
        buildPrevText("Periodo precedente", kCurr.revenue, kPrev.revenue, true);

      document.getElementById("kpiRevenuePerDayPrev").innerHTML =
        buildPrevText("Periodo precedente", kCurr.revenuePerDay, kPrev.revenuePerDay, false, 2);

      document.getElementById("kpiNumPrenPrev").innerHTML =
        buildPrevText("Periodo precedente", kCurr.numPren, kPrev.numPren, false, 0);

      // Prenotazioni effettive Gen 2026
      const prenGen = computeJan2026Kpi(filters);
      document.getElementById("kpiPrenGen2026").textContent = formatNumber(prenGen,0);

      // Grafico
      updateChart(fleetData, allBookings, fleetStations2025, filters);
    }

    function resetFilters() {
      ["yearFilter","monthFilter","tipoFilter","gruppoFilter","acquisizioneFilter","stazioneFilter"]
        .forEach(id => {
          const sel = document.getElementById(id);
          for (let i=0; i<sel.options.length; i++) sel.options[i].selected = true;
        });
      document.getElementById("projectionSelect").value = "0.10";
      updateDashboard();
    }

    // ================== INIT ==================
    async function initDashboard() {
      try {
        [fleetData, fleetStations2025, bookings2025, bookingsJan2026] = await Promise.all([
          loadJsonClean("fleetData_clean.json"),
          loadJsonClean("fleetStations2025.json"),
          loadJsonClean("bookings2025.json"),
          loadJsonClean("bookingsJan2026.json")
        ]);

        // normalizzazione flotta
        fleetData = fleetData.map(row => {
          const refDate = row.refDate || row.DATA_RIF || row.dataRif || row.data_ref;
          const d = parseISO(refDate);
          return {
            ...row,
            refDate,
            refDateObj: d,
            year: getYear(d),
            month: getMonth(d),
            gruppoKey: normalizeKey(row.gruppo),
            gruppoLabel: normalizeLabel(row.gruppo),
            tipoKey: normalizeKey(row.tipologia || row.tipo || ""),
            tipoLabel: normalizeLabel(row.tipologia || row.tipo || ""),
            acqKey: normalizeKey(row.acquisizione),
            acqLabel: normalizeLabel(row.acquisizione),
            stationKey: normalizeKey(row.stazione || row.station || ""),
            stationLabel: normalizeLabel(row.stazione || row.station || ""),
            canoneImponibile: Number(row.canoneImponibile || row.CANONE_IMPONIBILE || 0),
            assicurazione:   Number(row.assicurazione   || row.COPERTURA_ASS   || 0)
          };
        });

        // normalizzazione stazioni
        fleetStations2025 = fleetStations2025.map(s => {
          const d = parseISO(s.date || s.DATA || s.data);
          const year = s.year || getYear(d);
          const month= s.month|| getMonth(d);
          return {
            ...s,
            dateObj: d,
            year,
            month,
            groupKey: normalizeKey(s.group || s.gruppo),
            groupLabel: normalizeLabel(s.group || s.gruppo),
            stationKey: normalizeKey(s.station || s.stazione),
            stationLabel: normalizeLabel(s.station || s.stazione),
            fleet: Number(s.fleet || s.FLOTTA || 0)
          };
        });

        // bookings 2025
        const bSample = bookings2025[0] || {};
        const bGroupCol = detectColumn(bSample, ["gruppo","group","cartype","car_type","tipologia","tipo"]);
        const bTipoCol  = detectColumn(bSample, ["tipologia","tipo"]);
        const bAcqCol   = detectColumn(bSample, ["acquisizione","acquisition"]);
        const bStatCol  = detectColumn(bSample, ["stazione","station"]);
        const bDurCol   = detectColumn(bSample, ["duration","durata"]);
        const bPriceCol = detectColumn(bSample, ["price","prezzo","revenue"]);

        bookings2025 = bookings2025.map(b => {
          const d = parseISO(b.startDate || b.DATA_INIZIO || b.dataInizio || b.From);
          return {
            ...b,
            startDate: (b.startDate || b.DATA_INIZIO || b.dataInizio || b.From),
            year: getYear(d),
            month: getMonth(d),
            gruppoKey: normalizeKey(bGroupCol ? b[bGroupCol] : ""),
            gruppoLabel: normalizeLabel(bGroupCol ? b[bGroupCol] : ""),
            tipoKey: normalizeKey(bTipoCol ? b[bTipoCol] : ""),
            tipoLabel: normalizeLabel(bTipoCol ? b[bTipoCol] : ""),
            acqKey: normalizeKey(bAcqCol ? b[bAcqCol] : ""),
            acqLabel: normalizeLabel(bAcqCol ? b[bAcqCol] : ""),
            stationKey: normalizeKey(bStatCol ? b[bStatCol] : ""),
            stationLabel: normalizeLabel(bStatCol ? b[bStatCol] : ""),
            duration: Number(bDurCol ? b[bDurCol] : b.duration || 0),
            price:    Number(bPriceCol ? b[bPriceCol] : b.price || 0)
          };
        });

        // bookings Jan 2026
        const bjSample = bookingsJan2026[0] || {};
        const bjGroupCol = detectColumn(bjSample, ["gruppo","group","cartype","car_type","tipologia","tipo"]);
        const bjTipoCol  = detectColumn(bjSample, ["tipologia","tipo"]);
        const bjAcqCol   = detectColumn(bjSample, ["acquisizione","acquisition"]);
        const bjStatCol  = detectColumn(bjSample, ["stazione","station"]);
        const bjDurCol   = detectColumn(bjSample, ["duration","durata"]);
        const bjPriceCol = detectColumn(bjSample, ["price","prezzo","revenue"]);

        bookingsJan2026 = bookingsJan2026.map(b => {
          const d = parseISO(b.startDate || b.DATA_INIZIO || b.dataInizio || b.From);
          return {
            ...b,
            startDate: (b.startDate || b.DATA_INIZIO || b.dataInizio || b.From),
            year: getYear(d),
            month: getMonth(d),
            gruppoKey: normalizeKey(bjGroupCol ? b[bjGroupCol] : ""),
            gruppoLabel: normalizeLabel(bjGroupCol ? b[bjGroupCol] : ""),
            tipoKey: normalizeKey(bjTipoCol ? b[bjTipoCol] : ""),
            tipoLabel: normalizeLabel(bjTipoCol ? b[bjTipoCol] : ""),
            acqKey: normalizeKey(bjAcqCol ? b[bjAcqCol] : ""),
            acqLabel: normalizeLabel(bjAcqCol ? b[bjAcqCol] : ""),
            stationKey: normalizeKey(bjStatCol ? b[bjStatCol] : ""),
            stationLabel: normalizeLabel(bjStatCol ? b[bjStatCol] : ""),
            duration: Number(bjDurCol ? b[bjDurCol] : b.duration || 0),
            price:    Number(bjPriceCol ? b[bjPriceCol] : b.price || 0)
          };
        });

        const defaultProj = parseFloat(document.getElementById("projectionSelect").value);
        const allBookings = generateAllBookings(defaultProj);

        populateFilterOptions(fleetData, allBookings, fleetStations2025);

        ["yearFilter","monthFilter","tipoFilter","gruppoFilter",
         "acquisizioneFilter","stazioneFilter","projectionSelect"]
          .forEach(id => {
            document.getElementById(id).addEventListener("change", updateDashboard);
          });

        document.getElementById("resetFiltersBtn")
          .addEventListener("click", resetFilters);

        updateDashboard();
      } catch (err) {
        console.error(err);
        alert("Errore nel caricamento dei dati JSON. Controlla i file nel repository.");
      }
    }

    document.addEventListener("DOMContentLoaded", initDashboard);
  </script>
</body>
</html>
