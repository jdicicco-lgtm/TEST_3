<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Flotta & Prenotazioni</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-100 text-slate-900">
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold tracking-tight text-slate-800">
          Dashboard Flotta &amp; Prenotazioni üöóüìä
        </h1>
        <p class="text-sm text-slate-500">
          Analisi 2024‚Äì2026 ¬∑ Flotta, Costi &amp; Revenue (con proiezioni)
        </p>
      </div>
      <div>
        <span class="inline-flex items-center rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700">
          Static HTML ¬∑ JSON Data ¬∑ GitHub Pages
        </span>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- FILTRI -->
      <aside class="lg:col-span-1 bg-white rounded-2xl shadow p-4 space-y-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
            Filtri üéõÔ∏è
          </h2>
          <button
            id="resetFiltersBtn"
            class="text-xs px-3 py-1 rounded-full border border-slate-300 text-slate-600 hover:bg-slate-100 transition"
          >
            Pulisci filtri
          </button>
        </div>

        <!-- Anno -->
        <details class="group rounded-xl border border-slate-200 bg-slate-50 open:bg-slate-50">
          <summary class="flex items-center justify-between px-3 py-2 cursor-pointer list-none">
            <div>
              <p class="text-xs font-semibold text-slate-600">Anno</p>
              <p class="text-[10px] text-slate-400">Multi-selezione</p>
            </div>
            <span class="text-xs text-slate-400 group-open:rotate-90 transition-transform">‚ñ∂</span>
          </summary>
          <div class="px-3 pb-3">
            <select
              id="yearFilter"
              multiple
              class="w-full rounded-lg border border-slate-200 bg-white text-sm px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-slate-400"
            ></select>
          </div>
        </details>

        <!-- Mese -->
        <details class="group rounded-xl border border-slate-200 bg-slate-50">
          <summary class="flex items-center justify-between px-3 py-2 cursor-pointer list-none">
            <div>
              <p class="text-xs font-semibold text-slate-600">Mese</p>
              <p class="text-[10px] text-slate-400">Gen‚ÄìDic</p>
            </div>
            <span class="text-xs text-slate-400 group-open:rotate-90 transition-transform">‚ñ∂</span>
          </summary>
          <div class="px-3 pb-3">
            <select
              id="monthFilter"
              multiple
              class="w-full rounded-lg border border-slate-200 bg-white text-sm px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-slate-400"
            ></select>
          </div>
        </details>

        <!-- Gruppo Veicolo -->
        <details class="group rounded-xl border border-slate-200 bg-slate-50">
          <summary class="flex items-center justify-between px-3 py-2 cursor-pointer list-none">
            <div>
              <p class="text-xs font-semibold text-slate-600">Gruppo veicolo</p>
              <p class="text-[10px] text-slate-400">Chiave da stazioni 2025</p>
            </div>
            <span class="text-xs text-slate-400 group-open:rotate-90 transition-transform">‚ñ∂</span>
          </summary>
          <div class="px-3 pb-3">
            <select
              id="gruppoFilter"
              multiple
              class="w-full rounded-lg border border-slate-200 bg-white text-sm px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-slate-400"
            ></select>
          </div>
        </details>

        <!-- Acquisizione -->
        <details class="group rounded-xl border border-slate-200 bg-slate-50">
          <summary class="flex items-center justify-between px-3 py-2 cursor-pointer list-none">
            <div>
              <p class="text-xs font-semibold text-slate-600">Acquisizione</p>
            </div>
            <span class="text-xs text-slate-400 group-open:rotate-90 transition-transform">‚ñ∂</span>
          </summary>
          <div class="px-3 pb-3">
            <select
              id="acquisizioneFilter"
              multiple
              class="w-full rounded-lg border border-slate-200 bg-white text-sm px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-slate-400"
            ></select>
          </div>
        </details>

        <!-- Stazione -->
        <details class="group rounded-xl border border-slate-200 bg-slate-50">
          <summary class="flex items-center justify-between px-3 py-2 cursor-pointer list-none">
            <div>
              <p class="text-xs font-semibold text-slate-600">Stazione</p>
            </div>
            <span class="text-xs text-slate-400 group-open:rotate-90 transition-transform">‚ñ∂</span>
          </summary>
          <div class="px-3 pb-3">
            <select
              id="stazioneFilter"
              multiple
              class="w-full rounded-lg border border-slate-200 bg-white text-sm px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-slate-400"
            ></select>
          </div>
        </details>

        <!-- Percentuale proiezione 2026 -->
        <details class="group rounded-xl border border-slate-200 bg-slate-50">
          <summary class="flex items-center justify-between px-3 py-2 cursor-pointer list-none">
            <div>
              <p class="text-xs font-semibold text-slate-600">Proiezione 2026 üîÆ</p>
              <p class="text-[10px] text-slate-400">% aumento su 2025</p>
            </div>
            <span class="text-xs text-slate-400 group-open:rotate-90 transition-transform">‚ñ∂</span>
          </summary>
          <div class="px-3 pb-3">
            <select
              id="projectionSelect"
              class="w-full rounded-lg border border-slate-200 bg-white text-sm px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-slate-400"
            >
              <option value="0.05">+5%</option>
              <option value="0.10" selected>+10% (default)</option>
              <option value="0.15">+15%</option>
              <option value="0.20">+20%</option>
            </select>
            <p class="text-[11px] text-slate-400 mt-1">
              Valido solo per le prenotazioni proiettate Feb‚ÄìDic 2026.
            </p>
          </div>
        </details>
      </aside>

      <!-- CONTENUTO PRINCIPALE -->
      <section class="lg:col-span-3 space-y-6">
        <!-- DATA CARDS PRINCIPALI -->
        <div>
          <h2 class="text-sm font-semibold text-slate-600 mb-2">
            Indicatori principali (periodo filtrato) ‚≠ê
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Dimensione Flotta -->
            <div class="bg-white rounded-2xl shadow px-4 py-3">
              <p class="text-xs font-semibold text-slate-500">Dimensione Flotta (media veicoli)</p>
              <p id="kpiFleetSize" class="text-xl font-bold text-slate-900 mt-1">-</p>
              <p id="kpiFleetSizePrev" class="text-[11px] text-slate-400 mt-1">
                Periodo precedente: -
              </p>
            </div>

            <!-- Canone Imponibile -->
            <div class="bg-white rounded-2xl shadow px-4 py-3">
              <p class="text-xs font-semibold text-slate-500">Canone Imponibile</p>
              <p id="kpiCanone" class="text-xl font-bold text-slate-900 mt-1">-</p>
              <p id="kpiCanonePrev" class="text-[11px] text-slate-400 mt-1">
                Periodo precedente: -
              </p>
            </div>

            <!-- Canone Totale IVATO -->
            <div class="bg-white rounded-2xl shadow px-4 py-3">
              <p class="text-xs font-semibold text-slate-500">Canone Totale (IVATO)</p>
              <p id="kpiCanoneIvato" class="text-xl font-bold text-slate-900 mt-1">-</p>
              <p class="text-[11px] text-slate-400 mt-1">
                Calcolato con IVA 22% su Canone Imponibile.
              </p>
            </div>

            <!-- Assicurazione -->
            <div class="bg-white rounded-2xl shadow px-4 py-3">
              <p class="text-xs font-semibold text-slate-500">Assicurazione</p>
              <p id="kpiAssicurazione" class="text-xl font-bold text-slate-900 mt-1">-</p>
              <p id="kpiAssicurazionePrev" class="text-[11px] text-slate-400 mt-1">
                Periodo precedente: -
              </p>
            </div>

            <!-- Costo Totale -->
            <div class="bg-white rounded-2xl shadow px-4 py-3">
              <p class="text-xs font-semibold text-slate-500">Costo Totale (Canone + Ass.)</p>
              <p id="kpiCostoTotale" class="text-xl font-bold text-slate-900 mt-1">-</p>
              <p id="kpiCostoTotalePrev" class="text-[11px] text-slate-400 mt-1">
                Periodo precedente: -
              </p>
            </div>

            <!-- Revenue -->
            <div class="bg-white rounded-2xl shadow px-4 py-3">
              <p class="text-xs font-semibold text-slate-500">Revenue</p>
              <p id="kpiRevenue" class="text-xl font-bold text-slate-900 mt-1">-</p>
              <p id="kpiRevenuePrev" class="text-[11px] text-slate-400 mt-1">
                Periodo precedente: -
              </p>
            </div>

            <!-- Revenue per Day -->
            <div class="bg-white rounded-2xl shadow px-4 py-3">
              <p class="text-xs font-semibold text-slate-500">Revenue per Day</p>
              <p id="kpiRevenuePerDay" class="text-xl font-bold text-slate-900 mt-1">-</p>
              <p id="kpiRevenuePerDayPrev" class="text-[11px] text-slate-400 mt-1">
                Periodo precedente: -
              </p>
            </div>

            <!-- Numero Prenotazioni -->
            <div class="bg-white rounded-2xl shadow px-4 py-3">
              <p class="text-xs font-semibold text-slate-500">Numero Prenotazioni</p>
              <p id="kpiNumPren" class="text-xl font-bold text-slate-900 mt-1">-</p>
              <p id="kpiNumPrenPrev" class="text-[11px] text-slate-400 mt-1">
                Periodo precedente: -
              </p>
            </div>
          </div>
        </div>

        <!-- BLOCCO PROIEZIONI 2026 & DATI EFFETTIVI -->
        <div class="bg-slate-900 text-slate-50 rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-semibold tracking-wide">
              PROIEZIONI 2026 &amp; DATI EFFETTIVI üî≠
            </h2>
            <span class="text-[11px] text-slate-400">
              Gennaio 2026 = dati reali (no proiezione %)
            </span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-slate-800 rounded-2xl px-4 py-3">
              <p class="text-[11px] font-semibold text-slate-300">
                Prenotazioni Effettive (Gennaio 2026)
              </p>
              <p id="kpiPrenGen2026" class="text-2xl font-bold mt-1">-</p>
              <p class="text-[11px] text-slate-400 mt-1">
                Conteggio delle prenotazioni reali filtrate per dimensioni (non per % proiezione).
              </p>
            </div>
          </div>
        </div>

        <!-- GRAFICO PRINCIPALE -->
        <div class="bg-white rounded-2xl shadow p-4 h-[420px]">
          <p class="text-xs font-semibold text-slate-500 mb-2">
            Flotta, Costo Totale e Revenue per mese (periodo filtrato)
          </p>
          <canvas id="mainChart"></canvas>
        </div>
      </section>
    </div>
  </main>

  <script>
    let fleetData = [];
    let bookings2025 = [];
    let bookingsJan2026 = [];
    let fleetStations2025 = [];

    const monthNames = [
      "Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
      "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"
    ];

    function parseISO(dateStr) {
      return new Date(dateStr + "T00:00:00");
    }
    function getYear(d) { return d.getFullYear(); }
    function getMonth(d) { return d.getMonth() + 1; }

    function formatCurrency(value) {
      if (value == null || isNaN(value)) return "-";
      return value.toLocaleString("it-IT", {
        style: "currency",
        currency: "EUR",
        maximumFractionDigits: 0
      });
    }

    function formatNumber(value, decimals = 0) {
      if (value == null || isNaN(value)) return "-";
      return value.toLocaleString("it-IT", {
        maximumFractionDigits: decimals,
        minimumFractionDigits: decimals
      });
    }

    function normalizeKey(val) {
      if (val === null || val === undefined) return "";
      const s = String(val).trim();
      if (!s || s.toUpperCase() === "NAN") return "";
      return s.toUpperCase();
    }

    function normalizeLabel(val) {
      if (val === null || val === undefined) return "";
      const s = String(val).trim();
      if (!s || s.toUpperCase() === "NAN") return "";
      return s;
    }

    // Caricamento JSON con pulizia NaN numerici
    async function loadJsonClean(url) {
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`Errore nel caricamento di ${url}: status ${res.status}`);
      }
      let text = await res.text();
      text = text.replace(/\bNaN\b/g, "0");
      return JSON.parse(text);
    }

    // Generazione proiezioni prenotazioni
    function generateAllBookings(projectionFactor) {
      const all = [];

      bookings2025.forEach((b) => {
        const d2025 = parseISO(b.startDate);
        const year2025 = getYear(d2025);
        const month = getMonth(d2025);

        // 2025 reale
        all.push({ ...b, year: year2025, month });

        // 2024 = -5%
        const d2024 = new Date(d2025);
        d2024.setFullYear(year2025 - 1);
        all.push({
          ...b,
          year: getYear(d2024),
          month: getMonth(d2024),
          startDate: d2024.toISOString().slice(0, 10),
          price: (b.price || 0) * 0.95
        });

        // 2026 Feb‚ÄìDic = +X%
        const d2026 = new Date(d2025);
        d2026.setFullYear(year2025 + 1);
        const m2026 = getMonth(d2026);
        if (m2026 !== 1) {
          all.push({
            ...b,
            year: getYear(d2026),
            month: m2026,
            startDate: d2026.toISOString().slice(0, 10),
            price: (b.price || 0) * (1 + projectionFactor)
          });
        }
      });

      // Jan 2026 reale
      bookingsJan2026.forEach((b) => {
        const d = parseISO(b.startDate);
        all.push({ ...b, year: getYear(d), month: getMonth(d) });
      });

      return all;
    }

    // Popolamento filtri (con normalizzazione e deduplicazione)
    function populateFilterOptions(allFleet, allBookings, stationsData) {
      const yearSelect = document.getElementById("yearFilter");
      const monthSelect = document.getElementById("monthFilter");
      const gruppoSelect = document.getElementById("gruppoFilter");
      const acquisizioneSelect = document.getElementById("acquisizioneFilter");
      const stazioneSelect = document.getElementById("stazioneFilter");

      [yearSelect, monthSelect, gruppoSelect, acquisizioneSelect, stazioneSelect]
        .forEach(sel => sel.innerHTML = "");

      // Anni: limito a 2024‚Äì2026
      const years = new Set();
      allFleet.forEach(f => years.add(getYear(parseISO(f.refDate))));
      allBookings.forEach(b => years.add(b.year));
      stationsData.forEach(s => years.add(s.year));

      Array.from(years)
        .filter(y => y >= 2024 && y <= 2026)
        .sort()
        .forEach(y => {
          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          yearSelect.appendChild(opt);
        });

      // Mesi
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = monthNames[m - 1];
        monthSelect.appendChild(opt);
      }

      // Gruppi: chiave da fleetStations2025
      const groupMap = new Map(); // key -> label
      stationsData.forEach(s => {
        if (!s.groupKey) return;
        if (!groupMap.has(s.groupKey)) {
          groupMap.set(s.groupKey, s.groupLabel || s.groupKey);
        }
      });
      // eventuali gruppi presenti solo nella flotta / bookings
      allFleet.forEach(f => {
        if (f.groupKey && !groupMap.has(f.groupKey)) {
          groupMap.set(f.groupKey, f.gruppo || f.groupKey);
        }
      });
      allBookings.forEach(b => {
        if (b.groupKey && !groupMap.has(b.groupKey)) {
          groupMap.set(b.groupKey, b.gruppo || b.groupKey);
        }
      });

      Array.from(groupMap.entries())
        .sort((a,b) => a[1].localeCompare(b[1], "it"))
        .forEach(([key,label]) => {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = label;
          gruppoSelect.appendChild(opt);
        });

      // Acquisizione
      const acqMap = new Map();
      allFleet.forEach(f => {
        if (!f.acqKey) return;
        if (!acqMap.has(f.acqKey)) {
          acqMap.set(f.acqKey, f.acquisizione || f.acqKey);
        }
      });
      allBookings.forEach(b => {
        if (!b.acqKey) return;
        if (!acqMap.has(b.acqKey)) {
          acqMap.set(b.acqKey, b.acquisizione || b.acqKey);
        }
      });

      Array.from(acqMap.entries())
        .sort((a,b) => a[1].localeCompare(b[1], "it"))
        .forEach(([key,label]) => {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = label;
          acquisizioneSelect.appendChild(opt);
        });

      // Stazioni
      const stMap = new Map();
      stationsData.forEach(s => {
        if (!s.stationKey) return;
        if (!stMap.has(s.stationKey)) {
          stMap.set(s.stationKey, s.stationLabel || s.stationKey);
        }
      });
      allFleet.forEach(f => {
        if (!f.stationKey) return;
        if (!stMap.has(f.stationKey)) {
          stMap.set(f.stationKey, f.stazione || f.stationKey);
        }
      });
      allBookings.forEach(b => {
        if (!b.stationKey) return;
        if (!stMap.has(b.stationKey)) {
          stMap.set(b.stationKey, b.stazione || b.stationKey);
        }
      });

      Array.from(stMap.entries())
        .sort((a,b) => a[1].localeCompare(b[1], "it"))
        .forEach(([key,label]) => {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = label;
          stazioneSelect.appendChild(opt);
        });

      // Seleziona tutto di default
      [yearSelect, monthSelect, gruppoSelect, acquisizioneSelect, stazioneSelect]
        .forEach(sel => {
          for (let i = 0; i < sel.options.length; i++) {
            sel.options[i].selected = true;
          }
        });
    }

    function getMultiSelectValues(id) {
      const sel = document.getElementById(id);
      const vals = [];
      for (let i = 0; i < sel.options.length; i++) {
        if (sel.options[i].selected) vals.push(sel.options[i].value);
      }
      return vals;
    }

    // Range corrente / precedente
    function getCurrentAndPreviousRanges(filters) {
      const { years, months } = filters;

      const allYears = years.length ? years.map(y => parseInt(y, 10)) : [2024, 2025, 2026];
      const minYear = Math.min(...allYears);
      const maxYear = Math.max(...allYears);

      const allMonths = months.length ? months.map(m => parseInt(m, 10)) : [1, 12];
      const minMonth = months.length ? Math.min(...allMonths) : 1;
      const maxMonth = months.length ? Math.max(...allMonths) : 12;

      const startCurrent = new Date(minYear, minMonth - 1, 1);
      const endCurrent = new Date(maxYear, maxMonth, 0);

      const diffMonths =
        (endCurrent.getFullYear() - startCurrent.getFullYear()) * 12 +
        (endCurrent.getMonth() - startCurrent.getMonth()) + 1;

      const endPrev = new Date(startCurrent);
      endPrev.setMonth(endPrev.getMonth() - 1);
      const startPrev = new Date(endPrev);
      startPrev.setMonth(startPrev.getMonth() - (diffMonths - 1));
      startPrev.setDate(1);
      endPrev.setDate(new Date(endPrev.getFullYear(), endPrev.getMonth() + 1, 0).getDate());

      return {
        current: { start: startCurrent, end: endCurrent },
        previous: { start: startPrev, end: endPrev }
      };
    }

    function filterDataForRange(allFleet, allBookings, stationsData, filters, rangeKey) {
      const range = rangeKey === "current" ? filters.currentRange : filters.previousRange;
      const applyYearMonth = (rangeKey === "current"); // per il periodo precedente non forzo anno/mese

      const fleet = allFleet.filter(f => {
        const d = parseISO(f.refDate);
        const year = getYear(d);
        const month = getMonth(d);

        if (applyYearMonth) {
          if (filters.years.length && !filters.years.includes(String(year))) return false;
          if (filters.months.length && !filters.months.includes(String(month))) return false;
        }
        if (filters.gruppiKeys.length && f.groupKey && !filters.gruppiKeys.includes(f.groupKey)) return false;
        if (filters.acqKeys.length && f.acqKey && !filters.acqKeys.includes(f.acqKey)) return false;
        if (filters.stationKeys.length && f.stationKey && !filters.stationKeys.includes(f.stationKey)) return false;

        return d >= range.start && d <= range.end;
      });

      const bookings = allBookings.filter(b => {
        const d = parseISO(b.startDate);
        const year = b.year;
        const month = b.month;

        if (applyYearMonth) {
          if (filters.years.length && !filters.years.includes(String(year))) return false;
          if (filters.months.length && !filters.months.includes(String(month))) return false;
        }
        if (filters.gruppiKeys.length && b.groupKey && !filters.gruppiKeys.includes(b.groupKey)) return false;
        if (filters.acqKeys.length && b.acqKey && !filters.acqKeys.includes(b.acqKey)) return false;
        if (filters.stationKeys.length && b.stationKey && !filters.stationKeys.includes(b.stationKey)) return false;

        return d >= range.start && d <= range.end;
      });

      const stations = stationsData.filter(s => {
        const d = parseISO(s.date);
        const year = s.year;
        const month = s.month;

        if (applyYearMonth) {
          if (filters.years.length && !filters.years.includes(String(year))) return false;
          if (filters.months.length && !filters.months.includes(String(month))) return false;
        }
        if (filters.gruppiKeys.length && s.groupKey && !filters.gruppiKeys.includes(s.groupKey)) return false;
        if (filters.stationKeys.length && s.stationKey && !filters.stationKeys.includes(s.stationKey)) return false;

        return d >= range.start && d <= range.end;
      });

      return { fleet, bookings, stations };
    }

    // KPI: flotta = media dei conteggi mensili (usando fleetStations dove disponibile)
    function computeKpiForRange(fleet, bookings, stations) {
      const sumCanone = fleet.reduce((acc, f) => acc + (f.canoneImponibile || 0), 0);
      const sumAss = fleet.reduce((acc, f) => acc + (f.assicurazione || 0), 0);
      const costoTotale = sumCanone + sumAss;
      const canoneIvato = sumCanone * 1.22;

      const monthlyCounts = {};

      stations.forEach(s => {
        const key = `${s.year}-${String(s.month).padStart(2,"0")}`;
        monthlyCounts[key] = (monthlyCounts[key] || 0) + (s.fleet || 0);
      });

      fleet.forEach(f => {
        const d = parseISO(f.refDate);
        const y = getYear(d);
        const m = getMonth(d);
        const key = `${y}-${String(m).padStart(2,"0")}`;
        if (!(key in monthlyCounts)) {
          monthlyCounts[key] = (monthlyCounts[key] || 0) + 1;
        }
      });

      const values = Object.values(monthlyCounts);
      const fleetSize = values.length
        ? values.reduce((a,b)=>a+b,0) / values.length
        : 0;

      const sumRevenue = bookings.reduce((acc, b) => acc + (b.price || 0), 0);
      const sumDuration = bookings.reduce((acc, b) => acc + (b.duration || 0), 0);
      const revenuePerDay = sumDuration > 0 ? sumRevenue / sumDuration : null;
      const numPren = bookings.length;

      return {
        fleetSize,
        canone: sumCanone,
        canoneIvato,
        assicurazione: sumAss,
        costoTotale,
        revenue: sumRevenue,
        revenuePerDay,
        numPren
      };
    }

    function computeJan2026Kpi(filters) {
      const { gruppiKeys, acqKeys, stationKeys } = filters;
      const bookings = bookingsJan2026.filter(b => {
        if (gruppiKeys.length && b.groupKey && !gruppiKeys.includes(b.groupKey)) return false;
        if (acqKeys.length && b.acqKey && !acqKeys.includes(b.acqKey)) return false;
        if (stationKeys.length && b.stationKey && !stationKeys.includes(b.stationKey)) return false;
        return true;
      });
      return bookings.length;
    }

    let mainChartInstance = null;

    function updateMainChart(allFleet, allBookings, stationsData, filters) {
      // uso gli stessi dati filtrati del periodo corrente
      const { fleet, bookings, stations } = filterDataForRange(
        allFleet,
        allBookings,
        stationsData,
        filters,
        "current"
      );

      const buckets = {};

      stations.forEach(s => {
        const key = `${s.year}-${String(s.month).padStart(2,"0")}`;
        if (!buckets[key]) {
          buckets[key] = { fleetCount: 0, costoTotale: 0, revenue: 0 };
        }
        buckets[key].fleetCount += (s.fleet || 0);
      });

      fleet.forEach(f => {
        const d = parseISO(f.refDate);
        const y = getYear(d);
        const m = getMonth(d);
        const key = `${y}-${String(m).padStart(2,"0")}`;
        if (!buckets[key]) {
          buckets[key] = { fleetCount: 0, costoTotale: 0, revenue: 0 };
        }
        if (buckets[key].fleetCount === 0) {
          buckets[key].fleetCount += 1;
        }
        buckets[key].costoTotale += (f.canoneImponibile || 0) + (f.assicurazione || 0);
      });

      bookings.forEach(b => {
        const key = `${b.year}-${String(b.month).padStart(2,"0")}`;
        if (!buckets[key]) {
          buckets[key] = { fleetCount: 0, costoTotale: 0, revenue: 0 };
        }
        buckets[key].revenue += (b.price || 0);
      });

      const labels = Object.keys(buckets).sort();
      const fleetSeries = labels.map(k => buckets[k].fleetCount);
      const costSeries  = labels.map(k => buckets[k].costoTotale);
      const revSeries   = labels.map(k => buckets[k].revenue);

      const ctx = document.getElementById("mainChart").getContext("2d");
      if (mainChartInstance) mainChartInstance.destroy();

      mainChartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Flotta (media mensile)",
              data: fleetSeries,
              borderWidth: 2,
              tension: 0.2,
              yAxisID: "y"
            },
            {
              label: "Costo Totale (‚Ç¨)",
              data: costSeries,
              borderWidth: 2,
              tension: 0.2,
              yAxisID: "y1"
            },
            {
              label: "Revenue (‚Ç¨)",
              data: revSeries,
              borderWidth: 2,
              borderDash: [4, 4],
              tension: 0.2,
              yAxisID: "y1"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: "index",
            intersect: false
          },
          plugins: {
            tooltip: {
              callbacks: {
                title: (items) => {
                  if (!items.length) return "";
                  const label = items[0].label;
                  const [y, m] = label.split("-");
                  return `${monthNames[parseInt(m,10)-1]} ${y}`;
                },
                label: (item) => {
                  const datasetLabel = item.dataset.label || "";
                  if (datasetLabel.includes("Flotta")) {
                    return `${datasetLabel}: ${formatNumber(item.parsed.y, 1)}`;
                  }
                  return `${datasetLabel}: ${formatCurrency(item.parsed.y)}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                callback: function(value) {
                  const label = this.getLabelForValue(value);
                  const [y, m] = label.split("-");
                  return `${monthNames[parseInt(m,10)-1].slice(0,3)} ${y}`;
                }
              }
            },
            y: {
              type: "linear",
              position: "left",
              title: {
                display: true,
                text: "Flotta (veicoli)"
              },
              beginAtZero: true
            },
            y1: {
              type: "linear",
              position: "right",
              title: {
                display: true,
                text: "‚Ç¨"
              },
              beginAtZero: true,
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }

    function updateDashboard() {
      const projectionFactor = parseFloat(
        document.getElementById("projectionSelect").value
      );
      const allBookings = generateAllBookings(projectionFactor);

      const years = getMultiSelectValues("yearFilter");
      const months = getMultiSelectValues("monthFilter");
      const gruppiKeys = getMultiSelectValues("gruppoFilter");
      const acqKeys = getMultiSelectValues("acquisizioneFilter");
      const stationKeys = getMultiSelectValues("stazioneFilter");

      const ranges = getCurrentAndPreviousRanges({ years, months });

      const filters = {
        years,
        months,
        gruppiKeys,
        acqKeys,
        stationKeys,
        currentRange: ranges.current,
        previousRange: ranges.previous
      };

      const current = filterDataForRange(
        fleetData,
        allBookings,
        fleetStations2025,
        filters,
        "current"
      );
      const previous = filterDataForRange(
        fleetData,
        allBookings,
        fleetStations2025,
        filters,
        "previous"
      );

      const kpiCurrent = computeKpiForRange(current.fleet, current.bookings, current.stations);
      const kpiPrev    = computeKpiForRange(previous.fleet, previous.bookings, previous.stations);

      document.getElementById("kpiFleetSize").textContent      = formatNumber(kpiCurrent.fleetSize, 1);
      document.getElementById("kpiCanone").textContent         = formatCurrency(kpiCurrent.canone);
      document.getElementById("kpiCanoneIvato").textContent    = formatCurrency(kpiCurrent.canoneIvato);
      document.getElementById("kpiAssicurazione").textContent  = formatCurrency(kpiCurrent.assicurazione);
      document.getElementById("kpiCostoTotale").textContent    = formatCurrency(kpiCurrent.costoTotale);
      document.getElementById("kpiRevenue").textContent        = formatCurrency(kpiCurrent.revenue);
      document.getElementById("kpiRevenuePerDay").textContent  = formatNumber(kpiCurrent.revenuePerDay, 2);
      document.getElementById("kpiNumPren").textContent        = formatNumber(kpiCurrent.numPren, 0);

      document.getElementById("kpiFleetSizePrev").textContent =
        "Periodo precedente: " + formatNumber(kpiPrev.fleetSize, 1);
      document.getElementById("kpiCanonePrev").textContent =
        "Periodo precedente: " + formatCurrency(kpiPrev.canone);
      document.getElementById("kpiAssicurazionePrev").textContent =
        "Periodo precedente: " + formatCurrency(kpiPrev.assicurazione);
      document.getElementById("kpiCostoTotalePrev").textContent =
        "Periodo precedente: " + formatCurrency(kpiPrev.costoTotale);
      document.getElementById("kpiRevenuePrev").textContent =
        "Periodo precedente: " + formatCurrency(kpiPrev.revenue);
      document.getElementById("kpiRevenuePerDayPrev").textContent =
        "Periodo precedente: " + formatNumber(kpiPrev.revenuePerDay, 2);
      document.getElementById("kpiNumPrenPrev").textContent =
        "Periodo precedente: " + formatNumber(kpiPrev.numPren, 0);

      const prenGen2026 = computeJan2026Kpi(filters);
      document.getElementById("kpiPrenGen2026").textContent = formatNumber(prenGen2026, 0);

      updateMainChart(fleetData, allBookings, fleetStations2025, filters);
    }

    function resetFilters() {
      ["yearFilter","monthFilter","gruppoFilter","acquisizioneFilter","stazioneFilter"]
        .forEach(id => {
          const sel = document.getElementById(id);
          for (let i = 0; i < sel.options.length; i++) {
            sel.options[i].selected = true;
          }
        });
      document.getElementById("projectionSelect").value = "0.10";
      updateDashboard();
    }

    async function initDashboardWithJson() {
      try {
        [fleetData, bookings2025, bookingsJan2026, fleetStations2025] = await Promise.all([
          loadJsonClean("fleetData.json"),
          loadJsonClean("bookings2025.json"),
          loadJsonClean("bookingsJan2026.json"),
          loadJsonClean("fleetStations2025.json")
        ]);

        // normalizzo chiavi per join filtri
        fleetStations2025 = fleetStations2025.map(s => ({
          ...s,
          groupKey: normalizeKey(s.group),
          groupLabel: normalizeLabel(s.group),
          stationKey: normalizeKey(s.station),
          stationLabel: normalizeLabel(s.station)
        }));

        fleetData = fleetData.map(f => ({
          ...f,
          groupKey: normalizeKey(f.gruppo || f.group || f.CarType),
          acqKey: normalizeKey(f.acquisizione),
          stationKey: normalizeKey(f.stazione || f.station)
        }));

        bookings2025 = bookings2025.map(b => ({
          ...b,
          groupKey: normalizeKey(b.gruppo || b.group || b.CarType),
          acqKey: normalizeKey(b.acquisizione),
          stationKey: normalizeKey(b.stazione || b.station)
        }));

        bookingsJan2026 = bookingsJan2026.map(b => ({
          ...b,
          groupKey: normalizeKey(b.gruppo || b.group || b.CarType),
          acqKey: normalizeKey(b.acquisizione),
          stationKey: normalizeKey(b.stazione || b.station)
        }));

        const defaultProjectionFactor = parseFloat(
          document.getElementById("projectionSelect").value
        );
        const allBookings = generateAllBookings(defaultProjectionFactor);

        populateFilterOptions(fleetData, allBookings, fleetStations2025);

        [
          "yearFilter","monthFilter","gruppoFilter",
          "acquisizioneFilter","stazioneFilter","projectionSelect"
        ].forEach(id => {
          document.getElementById(id).addEventListener("change", updateDashboard);
        });

        document.getElementById("resetFiltersBtn")
          .addEventListener("click", resetFilters);

        updateDashboard();
      } catch (err) {
        console.error("Errore durante init dashboard:", err);
        alert("Errore nel caricamento dei dati JSON. Verifica che i file siano nella stessa cartella di index.html.");
      }
    }

    document.addEventListener("DOMContentLoaded", initDashboardWithJson);
  </script>
</body>
</html>
