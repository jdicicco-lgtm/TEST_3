<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard Flotta & Prenotazioni 2024‚Äì2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap 5 CSS (CDN) -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    />

    <style>
        body {
            background-color: #f5f5f7;
        }

        .kpi-card {
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            border: none;
            background: #ffffff;
            height: 100%;
        }

        .kpi-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
        }

        .kpi-value {
            font-size: 1.4rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }

        .kpi-previous {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .kpi-delta {
            font-size: 0.8rem;
            margin-top: 0.15rem;
            font-weight: 600;
        }

        .delta-positive {
            color: #198754; /* Bootstrap success */
        }

        .delta-negative {
            color: #dc3545; /* Bootstrap danger */
        }

        .delta-neutral {
            color: #6c757d; /* Bootstrap secondary */
        }

        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .filter-select {
            font-size: 0.85rem;
        }

        .accordion-button {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .chart-card {
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            border: none;
        }

        .no-print {
            /* Elements hidden in print */
        }

        .print-only {
            display: none;
        }

        @media print {
            body {
                background: #ffffff;
            }
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            .container-fluid {
                padding: 0;
            }
            .row {
                margin: 0;
            }
            .col-md-3,
            .col-md-9,
            .col-xl-3,
            .col-md-6 {
                float: none;
                width: 100%;
            }
            .kpi-card {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
<div class="container-fluid p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Dashboard Flotta &amp; Prenotazioni 2024‚Äì2026</h1>
        <div class="d-flex gap-2 no-print">
            <button id="downloadCsvBtn" class="btn btn-outline-secondary btn-sm">
                Scarica CSV dati filtrati
            </button>
            <button id="printBtn" class="btn btn-outline-primary btn-sm">
                Stampa / Esporta PDF
            </button>
        </div>
    </div>

    <div class="row g-3">
        <!-- FILTRI -->
        <div class="col-md-3 no-print">
            <div class="accordion" id="filtersAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="filtersHeading">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="true" aria-controls="filtersCollapse">
                            Filtri avanzati
                        </button>
                    </h2>
                    <div id="filtersCollapse" class="accordion-collapse collapse show" aria-labelledby="filtersHeading">
                        <div class="accordion-body">
                            <!-- Anno -->
                            <div class="mb-3">
                                <div class="filter-label">Anno</div>
                                <select id="yearFilter" class="form-select form-select-sm filter-select" multiple>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                </select>
                                <small class="text-muted">Selezione multipla (Ctrl+click).</small>
                            </div>

                            <!-- Mese -->
                            <div class="mb-3">
                                <div class="filter-label">Mese</div>
                                <select id="monthFilter" class="form-select form-select-sm filter-select" multiple>
                                    <option value="1">Gennaio</option>
                                    <option value="2">Febbraio</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Aprile</option>
                                    <option value="5">Maggio</option>
                                    <option value="6">Giugno</option>
                                    <option value="7">Luglio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Settembre</option>
                                    <option value="10">Ottobre</option>
                                    <option value="11">Novembre</option>
                                    <option value="12">Dicembre</option>
                                </select>
                            </div>

                            <!-- Gruppo veicolo -->
                            <div class="mb-3">
                                <div class="filter-label">Gruppo veicolo</div>
                                <select id="groupFilter" class="form-select form-select-sm filter-select" multiple>
                                    <option value="Commercial Van">Commercial Van</option>
                                    <option value="Large">Large</option>
                                    <option value="Economy">Economy</option>
                                    <option value="Small">Small</option>
                                    <option value="Mini">Mini</option>
                                    <option value="Premium">Premium</option>
                                    <option value="Suv">Suv</option>
                                    <option value="People Mover">People Mover</option>
                                    <option value="Station Wagon">Station Wagon</option>
                                    <option value="Cabriolet">Cabriolet</option>
                                </select>
                            </div>

                            <!-- Tipologia (opzionale, nascosta se non presente nei dati) -->
                            <div class="mb-3" id="tipologiaFilterContainer">
                                <div class="filter-label">Tipologia</div>
                                <select id="tipologiaFilter" class="form-select form-select-sm filter-select" multiple>
                                    <!-- Popolato via JS se disponibile -->
                                </select>
                            </div>

                            <!-- Acquisizione -->
                            <div class="mb-3">
                                <div class="filter-label">Acquisizione</div>
                                <select id="acquisitionFilter" class="form-select form-select-sm filter-select" multiple>
                                    <!-- Popolato via JS -->
                                </select>
                            </div>

                            <!-- Stazione -->
                            <div class="mb-3">
                                <div class="filter-label">Stazione</div>
                                <select id="stationFilter" class="form-select form-select-sm filter-select" multiple>
                                    <!-- Popolato via JS -->
                                </select>
                            </div>

                            <!-- Proiezione 2026 -->
                            <div class="mb-3">
                                <div class="filter-label">Proiezione 2026 üîÆ</div>
                                <select id="projectionSelect" class="form-select form-select-sm">
                                    <option value="0.05">5%</option>
                                    <option value="0.10" selected>10%</option>
                                    <option value="0.15">15%</option>
                                    <option value="0.20">20%</option>
                                </select>
                            </div>

                            <!-- Pulsante pulisci -->
                            <div class="d-grid">
                                <button id="clearFiltersBtn" class="btn btn-outline-secondary btn-sm">
                                    Pulisci filtri
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI + GRAFICO -->
        <div class="col-md-9">
            <!-- KPI ROW -->
            <div class="row g-3" id="kpiRow">
                <!-- 1: Dimensione Flotta -->
                <div class="col-md-6 col-xl-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="kpi-title">üöó Dimensione flotta (media)</div>
                            <div class="kpi-value" id="kpi-fleet-size-value">-</div>
                            <div class="kpi-previous text-muted" id="kpi-fleet-size-previous">Periodo prec.: -</div>
                            <div class="kpi-delta delta-neutral" id="kpi-fleet-size-delta">¬±0%</div>
                        </div>
                    </div>
                </div>

                <!-- 2: Canone Imponibile -->
                <div class="col-md-6 col-xl-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="kpi-title">üí∂ Canone imponibile</div>
                            <div class="kpi-value" id="kpi-canone-value">-</div>
                            <div class="kpi-previous text-muted" id="kpi-canone-previous">Periodo prec.: -</div>
                            <div class="kpi-delta delta-neutral" id="kpi-canone-delta">¬±0%</div>
                        </div>
                    </div>
                </div>

                <!-- 3: Canone Totale IVATO (solo descrittivo) -->
                <div class="col-md-6 col-xl-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="kpi-title">üí∂ Canone totale IVATO</div>
                            <div class="kpi-value" id="kpi-canone-ivato-value">-</div>
                            <div class="kpi-previous text-muted" id="kpi-canone-ivato-previous">Descrittivo</div>
                            <div class="kpi-delta delta-neutral" id="kpi-canone-ivato-delta"></div>
                        </div>
                    </div>
                </div>

                <!-- 4: Assicurazione -->
                <div class="col-md-6 col-xl-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="kpi-title">üõ°Ô∏è Assicurazione</div>
                            <div class="kpi-value" id="kpi-assicurazione-value">-</div>
                            <div class="kpi-previous text-muted" id="kpi-assicurazione-previous">Periodo prec.: -</div>
                            <div class="kpi-delta delta-neutral" id="kpi-assicurazione-delta">¬±0%</div>
                        </div>
                    </div>
                </div>

                <!-- 5: Costo totale -->
                <div class="col-md-6 col-xl-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="kpi-title">üí∞ Costo totale</div>
                            <div class="kpi-value" id="kpi-costo-totale-value">-</div>
                            <div class="kpi-previous text-muted" id="kpi-costo-totale-previous">Periodo prec.: -</div>
                            <div class="kpi-delta delta-neutral" id="kpi-costo-totale-delta">¬±0%</div>
                        </div>
                    </div>
                </div>

                <!-- 6: Revenue -->
                <div class="col-md-6 col-xl-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="kpi-title">üí∏ Revenue</div>
                            <div class="kpi-value" id="kpi-revenue-value">-</div>
                            <div class="kpi-previous text-muted" id="kpi-revenue-previous">Periodo prec.: -</div>
                            <div class="kpi-delta delta-neutral" id="kpi-revenue-delta">¬±0%</div>
                        </div>
                    </div>
                </div>

                <!-- 7: Revenue per day -->
                <div class="col-md-6 col-xl-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="kpi-title">‚òÄÔ∏è Revenue per day</div>
                            <div class="kpi-value" id="kpi-revenue-day-value">-</div>
                            <div class="kpi-previous text-muted" id="kpi-revenue-day-previous">Periodo prec.: -</div>
                            <div class="kpi-delta delta-neutral" id="kpi-revenue-day-delta">¬±0%</div>
                        </div>
                    </div>
                </div>

                <!-- 8: Numero prenotazioni -->
                <div class="col-md-6 col-xl-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="kpi-title">üìù Numero prenotazioni</div>
                            <div class="kpi-value" id="kpi-num-prenotazioni-value">-</div>
                            <div class="kpi-previous text-muted" id="kpi-num-prenotazioni-previous">Periodo prec.: -</div>
                            <div class="kpi-delta delta-neutral" id="kpi-num-prenotazioni-delta">¬±0%</div>
                        </div>
                    </div>
                </div>

                <!-- 9: Veicoli effettivamente noleggiati -->
                <div class="col-md-6 col-xl-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="kpi-title">üöô Veicoli effettivamente noleggiati</div>
                            <div class="kpi-value" id="kpi-vehicles-rented-value">-</div>
                            <div class="kpi-previous text-muted" id="kpi-vehicles-rented-previous">Periodo prec.: -</div>
                            <div class="kpi-delta delta-neutral" id="kpi-vehicles-rented-delta">¬±0%</div>
                        </div>
                    </div>
                </div>

                <!-- 10: Prenotazioni effettive Gennaio 2026 -->
                <div class="col-md-6 col-xl-3">
                    <div class="card kpi-card">
                        <div class="card-body">
                            <div class="kpi-title">‚úÖ Prenotazioni effettive (Gennaio 2026)</div>
                            <div class="kpi-value" id="kpi-prenotazioni-gen26-value">-</div>
                            <div class="kpi-previous text-muted" id="kpi-prenotazioni-gen26-previous">
                                Filtrate solo per gruppo/acquisizione/stazione
                            </div>
                            <div class="kpi-delta delta-neutral" id="kpi-prenotazioni-gen26-delta"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GRAFICO -->
            <div class="card chart-card mt-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">Andamento mensile flotta, costi e prenotazioni</h5>
                    <canvas id="mainChart" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 JS (for accordion etc.) -->
<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    // =========================
    // COSTANTI & VARIABILI GLOBALI
    // =========================

    const GROUP_LABELS = [
        "Commercial Van",
        "Large",
        "Economy",
        "Small",
        "Mini",
        "Premium",
        "Suv",
        "People Mover",
        "Station Wagon",
        "Cabriolet"
    ];

    const IT_MONTH_NAMES = [
        "Gen", "Feb", "Mar", "Apr", "Mag", "Giu",
        "Lug", "Ago", "Set", "Ott", "Nov", "Dic"
    ];

    let fleetData = [];              // dati flotta normalizzati
    let baseBookings2025 = [];       // prenotazioni 2025 normalizzate (base)
    let jan2026Bookings = [];        // prenotazioni gennaio 2026 normalizzate (real)
    let allBookings = [];            // prenotazioni 2024-2026 (real + proiezioni)
    let stationsList = new Set();    // lista stazioni
    let acquisitionList = new Set(); // lista acquisizioni
    let tipologiaList = new Set();   // lista tipologie (se presente)

    let chartInstance = null;

    // =========================
    // UTILITY GENERALI
    // =========================

    function parseDateFlexible(value) {
        if (!value) return null;
        if (value instanceof Date) return value;
        const d = new Date(value);
        if (!isNaN(d.getTime())) return d;
        // fallback semplice (se formati strani): prova a sostituire / con -
        try {
            const d2 = new Date(String(value).replace(/\//g, "-"));
            if (!isNaN(d2.getTime())) return d2;
        } catch (e) {}
        return null;
    }

    function ymToIndex(year, month) {
        return year * 12 + (month - 1);
    }

    function indexToYm(index) {
        return {
            year: Math.floor(index / 12),
            month: (index % 12) + 1
        };
    }

    function formatCurrency(value) {
        if (value == null || isNaN(value)) return "-";
        return new Intl.NumberFormat("it-IT", {
            style: "currency",
            currency: "EUR",
            maximumFractionDigits: 0
        }).format(value);
    }

    function formatNumber(value, decimals = 0) {
        if (value == null || isNaN(value)) return "-";
        return new Intl.NumberFormat("it-IT", {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(value);
    }

    function monthLabel(year, month) {
        return IT_MONTH_NAMES[month - 1] + " " + year;
    }

    function getSelectedValues(selectEl) {
        const values = [];
        Array.from(selectEl.options).forEach(opt => {
            if (opt.selected) {
                values.push(opt.value);
            }
        });
        return new Set(values);
    }

    function setAllOptionsSelected(selectEl, selected = true) {
        Array.from(selectEl.options).forEach(opt => {
            opt.selected = selected;
        });
    }

    function isValueSelected(selectedSet, value) {
        if (!selectedSet || selectedSet.size === 0) return true;
        return selectedSet.has(String(value));
    }

    function isValueSelectedCaseInsensitive(selectedSet, value) {
        if (!selectedSet || selectedSet.size === 0) return true;
        if (value == null) return false;
        const setUpper = new Set(Array.from(selectedSet).map(v => String(v).toUpperCase()));
        return setUpper.has(String(value).toUpperCase());
    }

    // =========================
    // DETECTION CAMPI (robustezza nomi)
    // =========================

    function detectFieldName(sample, candidates) {
        if (!sample) return null;
        const keys = Object.keys(sample);
        for (const cand of candidates) {
            const lowerCand = cand.toLowerCase();
            for (const k of keys) {
                if (k.toLowerCase() === lowerCand) {
                    return k;
                }
            }
        }
        return null;
    }

    // =========================
    // NORMALIZZAZIONE FLOTTA
    // =========================

    function mapGroupLabel(raw) {
        if (!raw) return null;
        let r = String(raw).trim();
        if (!r) return null;
        let upper = r.toUpperCase();

        // Mappature specifiche per casi noti
        if (upper === "VAN") return "People Mover";      // come richiesto in precedenza
        if (upper === "FURGONE") return "Commercial Van";
        if (upper.includes("COMMERCIAL")) return "Commercial Van";
        if (upper.includes("PEOPLE")) return "People Mover";
        if (upper === "SUV") return "Suv";
        if (upper === "STATION WAGON") return "Station Wagon";

        // match diretto su lista fissa
        for (const label of GROUP_LABELS) {
            if (upper === label.toUpperCase()) {
                return label;
            }
        }

        // fallback: restituisci stringa originale (cos√¨ almeno non buttiamo dati)
        return r;
    }

    function normalizeFleetData(rawFleet) {
        if (!Array.isArray(rawFleet)) return [];

        const sample = rawFleet[0] || {};
        const dateField = detectFieldName(sample, ["refDate", "date", "data", "referenceDate"]);
        const groupField = detectFieldName(sample, ["gruppo", "group", "carGroup", "categoria"]);
        const acqField = detectFieldName(sample, ["acquisizione", "acquisition", "tipo_acquisizione"]);
        const stationField = detectFieldName(sample, ["stazione", "station", "location"]);
        const canoneField = detectFieldName(sample, ["canoneImponibile", "canone_imponibile", "canone"]);
        const assField = detectFieldName(sample, ["assicurazione", "insurance", "premio_assicurativo"]);
        const tipologiaField = detectFieldName(sample, ["tipologia", "tipo"]);

        const normalized = [];

        for (const row of rawFleet) {
            const d = parseDateFlexible(row[dateField]);
            if (!d) continue;
            const year = d.getFullYear();
            const month = d.getMonth() + 1;

            const groupRaw = groupField ? row[groupField] : null;
            const groupLabel = mapGroupLabel(groupRaw);

            const acq = acqField ? (row[acqField] || "").toString().trim() : "";
            const station = stationField ? (row[stationField] || "").toString().trim() : "";
            const canone = canoneField ? Number(row[canoneField]) || 0 : 0;
            const ass = assField ? Number(row[assField]) || 0 : 0;
            const tip = tipologiaField ? (row[tipologiaField] || "").toString().trim() : "";

            if (station) stationsList.add(station);
            if (acq) acquisitionList.add(acq);
            if (tip) tipologiaList.add(tip);

            normalized.push({
                raw: row,
                date: d,
                year,
                month,
                groupLabel,
                acquisition: acq,
                station,
                canoneImponibile: canone,
                assicurazione: ass,
                tipologia: tip
            });
        }

        return normalized;
    }

    // =========================
    // NORMALIZZAZIONE PRENOTAZIONI
    // =========================

    function normalizeBookings(rawBookings, isJan2026 = false) {
        if (!Array.isArray(rawBookings)) return [];

        const sample = rawBookings[0] || {};
        const dateField = detectFieldName(sample, [
            "startDate", "from", "data_inizio", "DATA_INIZIO", "bookingStart", "start"
        ]);
        const groupField = detectFieldName(sample, [
            "gruppo", "group", "carGroup", "car_type", "carType"
        ]);
        const stationField = detectFieldName(sample, [
            "stazione", "station", "location"
        ]);
        const acqField = detectFieldName(sample, [
            "acquisizione", "acquisition", "tipo_acquisizione"
        ]);
        const durationField = detectFieldName(sample, [
            "duration", "giorni", "days", "giorni_noleggio"
        ]);
        const priceField = detectFieldName(sample, [
            "price", "revenue", "amount", "totale", "total"
        ]);
        const vehicleField = detectFieldName(sample, [
            "targa", "plate", "vehicleId", "id_vehicle", "car_id", "idVeicolo"
        ]);

        const normalized = [];

        for (let idx = 0; idx < rawBookings.length; idx++) {
            const row = rawBookings[idx];
            const d = parseDateFlexible(row[dateField]);
            if (!d) continue;
            const year = d.getFullYear();
            const month = d.getMonth() + 1;

            const groupRaw = groupField ? row[groupField] : null;
            const groupLabel = mapGroupLabel(groupRaw);

            const station = stationField ? (row[stationField] || "").toString().trim() : "";
            const acq = acqField ? (row[acqField] || "").toString().trim() : "";
            const duration = durationField ? Number(row[durationField]) || 0 : 0;
            const price = priceField ? Number(row[priceField]) || 0 : 0;
            const vehicleId = vehicleField ? (row[vehicleField] || "").toString().trim() : "BOOKING_" + idx + "_" + (isJan2026 ? "J26" : "B25");

            if (station) stationsList.add(station);
            if (acq) acquisitionList.add(acq);

            normalized.push({
                raw: row,
                date: d,
                year,
                month,
                groupLabel,
                station,
                acquisition: acq,
                duration,
                price,
                vehicleId
            });
        }

        return normalized;
    }

    // =========================
    // PROIEZIONI BOOKING 2024‚Äì2026
    // =========================

    function generateAllBookings(projectionFactor) {
        const all = [];

        // 2025 reali + proiezioni 2024/2026 basate su booking 2025
        for (const b of baseBookings2025) {
            // 2025 reale
            all.push({ ...b });

            // 2024: -1 anno, -5% price
            const d2024 = new Date(b.date.getTime());
            d2024.setFullYear(b.year - 1);
            all.push({
                ...b,
                date: d2024,
                year: b.year - 1,
                month: b.month,
                price: b.price * 0.95 // -5%
            });

            // 2026: +1 anno, +projectionFactor, solo se mese != gennaio
            if (b.month !== 1) {
                const d2026 = new Date(b.date.getTime());
                d2026.setFullYear(b.year + 1);
                all.push({
                    ...b,
                    date: d2026,
                    year: b.year + 1,
                    month: b.month,
                    price: b.price * (1 + projectionFactor)
                });
            }
        }

        // Gennaio 2026 reale: nessuna proiezione
        for (const jb of jan2026Bookings) {
            all.push({ ...jb });
        }

        allBookings = all;
    }

    // =========================
    // FILTRI: RANGE CORRENTE / PRECEDENTE
    // =========================

    function getCurrentAndPreviousRanges(filters) {
        // Anni selezionati
        let years = Array.from(filters.yearsSelected).map(v => parseInt(v, 10)).filter(v => !isNaN(v));
        if (years.length === 0) {
            years = [2024, 2025, 2026];
        }
        years.sort((a, b) => a - b);

        // Mesi selezionati
        let months = Array.from(filters.monthsSelected).map(v => parseInt(v, 10)).filter(v => !isNaN(v));
        if (months.length === 0) {
            months = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
        }
        months.sort((a, b) => a - b);

        const startYear = years[0];
        const endYear = years[years.length - 1];
        const startMonth = months[0];
        const endMonth = months[months.length - 1];

        const startIndex = ymToIndex(startYear, startMonth);
        const endIndex = ymToIndex(endYear, endMonth);
        const monthsCount = endIndex - startIndex + 1;

        const currentStart = new Date(startYear, startMonth - 1, 1);
        const currentEnd = new Date(endYear, endMonth, 0); // ultimo giorno del mese

        let previousStart = null;
        let previousEnd = null;

        const prevEndIndex = startIndex - 1;
        if (prevEndIndex >= 0 && monthsCount > 0) {
            const prevStartIndex = prevEndIndex - (monthsCount - 1);
            const ymStart = indexToYm(prevStartIndex);
            const ymEnd = indexToYm(prevEndIndex);
            previousStart = new Date(ymStart.year, ymStart.month - 1, 1);
            previousEnd = new Date(ymEnd.year, ymEnd.month, 0);
        }

        return {
            current: { start: currentStart, end: currentEnd },
            previous: previousStart && previousEnd ? { start: previousStart, end: previousEnd } : null
        };
    }

    // =========================
    // FILTRAGGIO DATI PER RANGE
    // =========================

    function filterDataForRange(range, filters, includeTimeFiltersForCurrent, isPreviousRange) {
        const { start, end } = range;
        const fleet = [];
        const bookings = [];

        const yearsSelected = filters.yearsSelected;
        const monthsSelected = filters.monthsSelected;

        for (const f of fleetData) {
            if (!f.date || f.date < start || f.date > end) continue;

            // I filtri temporali (anno/mese) si applicano solo al periodo corrente
            if (includeTimeFiltersForCurrent) {
                if (!isValueSelected(yearsSelected, f.year)) continue;
                if (!isValueSelected(monthsSelected, f.month)) continue;
            }

            if (!isValueSelectedCaseInsensitive(filters.groupsSelected, f.groupLabel)) continue;
            if (!isValueSelectedCaseInsensitive(filters.acquisitionsSelected, f.acquisition)) continue;
            if (!isValueSelectedCaseInsensitive(filters.stationsSelected, f.station)) continue;

            if (filters.tipologieSelected && filters.tipologieSelected.size > 0) {
                if (!isValueSelectedCaseInsensitive(filters.tipologieSelected, f.tipologia)) continue;
            }

            fleet.push(f);
        }

        for (const b of allBookings) {
            if (!b.date || b.date < start || b.date > end) continue;

            if (includeTimeFiltersForCurrent) {
                if (!isValueSelected(yearsSelected, b.year)) continue;
                if (!isValueSelected(monthsSelected, b.month)) continue;
            }

            if (!isValueSelectedCaseInsensitive(filters.groupsSelected, b.groupLabel)) continue;
            if (!isValueSelectedCaseInsensitive(filters.acquisitionsSelected, b.acquisition)) continue;
            if (!isValueSelectedCaseInsensitive(filters.stationsSelected, b.station)) continue;

            bookings.push(b);
        }

        return { fleet, bookings };
    }

    // =========================
    // KPI: AGGREGAZIONI
    // =========================

    function computeFleetMonthlyCounts(fleet) {
        const map = new Map(); // key: YYYY-MM, value: count
        for (const f of fleet) {
            const key = f.year + "-" + String(f.month).padStart(2, "0");
            map.set(key, (map.get(key) || 0) + 1);
        }
        return map;
    }

    function computeFleetMonthlyCosts(fleet) {
        const mapCost = new Map();      // key => costo totale
        const mapCanone = new Map();    // key => canone imponibile
        const mapAss = new Map();       // key => assicurazione

        for (const f of fleet) {
            const key = f.year + "-" + String(f.month).padStart(2, "0");
            const canone = f.canoneImponibile || 0;
            const ass = f.assicurazione || 0;
            mapCanone.set(key, (mapCanone.get(key) || 0) + canone);
            mapAss.set(key, (mapAss.get(key) || 0) + ass);
            mapCost.set(key, (mapCost.get(key) || 0) + canone + ass);
        }

        return { mapCost, mapCanone, mapAss };
    }

    function computeBookingMonthlyAggregates(bookings) {
        const mapRevenue = new Map();
        const mapDuration = new Map();
        const mapBookingsCount = new Map();
        const mapVehicles = new Map(); // key => Set(vehicleId)

        for (const b of bookings) {
            const key = b.year + "-" + String(b.month).padStart(2, "0");
            mapRevenue.set(key, (mapRevenue.get(key) || 0) + (b.price || 0));
            mapDuration.set(key, (mapDuration.get(key) || 0) + (b.duration || 0));
            mapBookingsCount.set(key, (mapBookingsCount.get(key) || 0) + 1);

            const setV = mapVehicles.get(key) || new Set();
            setV.add(b.vehicleId);
            mapVehicles.set(key, setV);
        }

        return { mapRevenue, mapDuration, mapBookingsCount, mapVehicles };
    }

    function sumMap(map) {
        let s = 0;
        for (const v of map.values()) s += v;
        return s;
    }

    function countDistinctVehicles(bookings) {
        const set = new Set();
        for (const b of bookings) {
            set.add(b.vehicleId);
        }
        return set.size;
    }

    // =========================
    // UPDATE KPI CARD HELPER
    // =========================

    function updateKpiCard(options) {
        const {
            idPrefix,
            currentValue,
            previousValue,
            isCurrency = false,
            decimals = 0,
            showPrevious = true,
            showDelta = true
        } = options;

        const valueEl = document.getElementById(`kpi-${idPrefix}-value`);
        const prevEl = document.getElementById(`kpi-${idPrefix}-previous`);
        const deltaEl = document.getElementById(`kpi-${idPrefix}-delta`);

        if (valueEl) {
            valueEl.textContent = isCurrency
                ? formatCurrency(currentValue)
                : formatNumber(currentValue, decimals);
        }

        if (prevEl) {
            if (!showPrevious) {
                prevEl.textContent = "";
            } else {
                const prevText = isCurrency
                    ? formatCurrency(previousValue)
                    : formatNumber(previousValue, decimals);
                prevEl.textContent = "Periodo prec.: " + (prevText === "-" ? "-" : prevText);
            }
        }

        if (deltaEl) {
            deltaEl.classList.remove("delta-positive", "delta-negative", "delta-neutral");
            if (!showDelta || previousValue == null || isNaN(previousValue) || previousValue === 0) {
                deltaEl.textContent = showDelta ? "Œî %: N/A" : "";
                deltaEl.classList.add("delta-neutral");
            } else {
                const diff = currentValue - previousValue;
                const perc = (diff / Math.abs(previousValue)) * 100;
                const sign = diff > 0 ? "+" : diff < 0 ? "" : "¬±";
                deltaEl.textContent = `${sign}${formatNumber(perc, 1)}%`;
                if (diff > 0) {
                    deltaEl.classList.add("delta-positive");
                } else if (diff < 0) {
                    deltaEl.classList.add("delta-negative");
                } else {
                    deltaEl.classList.add("delta-neutral");
                }
            }
        }
    }

    // =========================
    // CALCOLO KPI GLOBALI
    // =========================

    function updateKpis(currentData, previousData, ranges, filters) {
        const currentFleet = currentData.fleet;
        const previousFleet = previousData ? previousData.fleet : [];
        const currentBookings = currentData.bookings;
        const previousBookings = previousData ? previousData.bookings : [];

        // Flotta: dimensione media per mese nel range selezionato
        const fleetMonthlyCurrent = computeFleetMonthlyCounts(currentFleet);
        const fleetMonthlyPrevious = computeFleetMonthlyCounts(previousFleet);

        const fleetMonthsCurrent = fleetMonthlyCurrent.size;
        const fleetMonthsPrevious = fleetMonthlyPrevious.size;

        const fleetSizeCurrent = fleetMonthsCurrent > 0 ? sumMap(fleetMonthlyCurrent) / fleetMonthsCurrent : 0;
        const fleetSizePrevious = fleetMonthsPrevious > 0 ? sumMap(fleetMonthlyPrevious) / fleetMonthsPrevious : 0;

        updateKpiCard({
            idPrefix: "fleet-size",
            currentValue: fleetSizeCurrent,
            previousValue: fleetSizePrevious,
            isCurrency: false,
            decimals: 1,
            showPrevious: true,
            showDelta: true
        });

        // Canoni e assicurazione
        const { mapCost: costMapCurrent, mapCanone: canoneMapCurrent, mapAss: assMapCurrent } =
            computeFleetMonthlyCosts(currentFleet);
        const { mapCost: costMapPrevious, mapCanone: canoneMapPrevious, mapAss: assMapPrevious } =
            computeFleetMonthlyCosts(previousFleet);

        const canoneCurrent = sumMap(canoneMapCurrent);
        const canonePrevious = sumMap(canoneMapPrevious);
        const assCurrent = sumMap(assMapCurrent);
        const assPrevious = sumMap(assMapPrevious);
        const costCurrent = sumMap(costMapCurrent);
        const costPrevious = sumMap(costMapPrevious);

        // Canone imponibile
        updateKpiCard({
            idPrefix: "canone",
            currentValue: canoneCurrent,
            previousValue: canonePrevious,
            isCurrency: true,
            decimals: 0,
            showPrevious: true,
            showDelta: true
        });

        // Canone IVATO (solo descrittivo)
        const canoneIvato = canoneCurrent * 1.22;
        const canoneIvatoElValue = document.getElementById("kpi-canone-ivato-value");
        if (canoneIvatoElValue) {
            canoneIvatoElValue.textContent = formatCurrency(canoneIvato);
        }
        const canoneIvatoDeltaEl = document.getElementById("kpi-canone-ivato-delta");
        if (canoneIvatoDeltaEl) {
            canoneIvatoDeltaEl.textContent = ""; // nessun confronto richiesto
        }

        // Assicurazione
        updateKpiCard({
            idPrefix: "assicurazione",
            currentValue: assCurrent,
            previousValue: assPrevious,
            isCurrency: true,
            decimals: 0,
            showPrevious: true,
            showDelta: true
        });

        // Costo totale
        updateKpiCard({
            idPrefix: "costo-totale",
            currentValue: costCurrent,
            previousValue: costPrevious,
            isCurrency: true,
            decimals: 0,
            showPrevious: true,
            showDelta: true
        });

        // Booking aggregati
        const {
            mapRevenue: revCurrentMap,
            mapDuration: durCurrentMap,
            mapBookingsCount: bookCurrentMap,
            mapVehicles: vehiclesCurrentMap
        } = computeBookingMonthlyAggregates(currentBookings);

        const {
            mapRevenue: revPrevMap,
            mapDuration: durPrevMap,
            mapBookingsCount: bookPrevMap,
            mapVehicles: vehiclesPrevMap
        } = computeBookingMonthlyAggregates(previousBookings);

        const revenueCurrent = sumMap(revCurrentMap);
        const revenuePrevious = sumMap(revPrevMap);

        const durationCurrent = sumMap(durCurrentMap);
        const durationPrevious = sumMap(durPrevMap);

        const numBookingCurrent = sumMap(bookCurrentMap);
        const numBookingPrevious = sumMap(bookPrevMap);

        const vehiclesCurrent = countDistinctVehicles(currentBookings);
        const vehiclesPrevious = countDistinctVehicles(previousBookings);

        const revenuePerDayCurrent = durationCurrent > 0 ? revenueCurrent / durationCurrent : 0;
        const revenuePerDayPrevious = durationPrevious > 0 ? revenuePrevious / durationPrevious : 0;

        // Revenue
        updateKpiCard({
            idPrefix: "revenue",
            currentValue: revenueCurrent,
            previousValue: revenuePrevious,
            isCurrency: true,
            decimals: 0,
            showPrevious: true,
            showDelta: true
        });

        // Revenue per day
        updateKpiCard({
            idPrefix: "revenue-day",
            currentValue: revenuePerDayCurrent,
            previousValue: revenuePerDayPrevious,
            isCurrency: true,
            decimals: 1,
            showPrevious: true,
            showDelta: true
        });

        // Numero prenotazioni
        updateKpiCard({
            idPrefix: "num-prenotazioni",
            currentValue: numBookingCurrent,
            previousValue: numBookingPrevious,
            isCurrency: false,
            decimals: 0,
            showPrevious: true,
            showDelta: true
        });

        // Veicoli effettivamente noleggiati
        updateKpiCard({
            idPrefix: "vehicles-rented",
            currentValue: vehiclesCurrent,
            previousValue: vehiclesPrevious,
            isCurrency: false,
            decimals: 0,
            showPrevious: true,
            showDelta: true
        });

        // Prenotazioni effettive Gennaio 2026 (SEM¬≠PRE solo gennaio 2026, filtro gruppo/acq/stazione/tipologia, no proiezione)
        const prenGen26Count = computePrenotazioniGennaio2026(filters);
        const prenGen26ValueEl = document.getElementById("kpi-prenotazioni-gen26-value");
        if (prenGen26ValueEl) {
            prenGen26ValueEl.textContent = formatNumber(prenGen26Count, 0);
        }
        const prenGen26DeltaEl = document.getElementById("kpi-prenotazioni-gen26-delta");
        if (prenGen26DeltaEl) prenGen26DeltaEl.textContent = "";
    }

    function computePrenotazioniGennaio2026(filters) {
        let count = 0;
        for (const b of jan2026Bookings) {
            if (b.month !== 1 || b.year !== 2026) continue;
            if (!isValueSelectedCaseInsensitive(filters.groupsSelected, b.groupLabel)) continue;
            if (!isValueSelectedCaseInsensitive(filters.acquisitionsSelected, b.acquisition)) continue;
            if (!isValueSelectedCaseInsensitive(filters.stationsSelected, b.station)) continue;
            if (filters.tipologieSelected && filters.tipologieSelected.size > 0) {
                // tipologia non prevista nei booking -> ignoriamo filtro tipologia per questo KPI
            }
            count++;
        }
        return count;
    }

    // =========================
    // GRAFICO CHART.JS
    // =========================

    function updateChart(currentData, ranges) {
        const ctx = document.getElementById("mainChart").getContext("2d");

        const currentFleet = currentData.fleet;
        const currentBookings = currentData.bookings;
        const { start, end } = ranges.current;

        const fleetMonthlyCounts = computeFleetMonthlyCounts(currentFleet);
        const { mapCost, mapCanone, mapAss } = computeFleetMonthlyCosts(currentFleet);
        const {
            mapRevenue,
            mapDuration,
            mapBookingsCount,
            mapVehicles
        } = computeBookingMonthlyAggregates(currentBookings);

        // Costruiamo asse X: tutti i mesi compresi tra start e end
        const labels = [];
        const flottaSeries = [];
        const costSeries = [];
        const revenueSeries = [];
        const vehiclesSeries = [];

        let idx = ymToIndex(start.getFullYear(), start.getMonth() + 1);
        const endIdx = ymToIndex(end.getFullYear(), end.getMonth() + 1);

        while (idx <= endIdx) {
            const { year, month } = indexToYm(idx);
            const key = year + "-" + String(month).padStart(2, "0");

            labels.push(monthLabel(year, month));
            flottaSeries.push(flottaSeriesValue(key, fleetMonthlyCounts));
            costSeries.push(mapCost.get(key) || 0);
            revenueSeries.push(mapRevenue.get(key) || 0);

            const setVehicles = mapVehicles.get(key);
            vehiclesSeries.push(setVehicles ? setVehicles.size : 0);

            idx++;
        }

        function flottaSeriesValue(key, map) {
            return map.get(key) || 0;
        }

        const data = {
            labels,
            datasets: [
                {
                    label: "Flotta (veicoli)",
                    data: flottaSeries,
                    yAxisID: "y",
                    tension: 0.3,
                    borderWidth: 2,
                    fill: false,
                    borderColor: "rgba(13,110,253,0.9)",
                    pointRadius: 2
                },
                {
                    label: "Costo totale (‚Ç¨)",
                    data: costSeries,
                    yAxisID: "y1",
                    tension: 0.3,
                    borderWidth: 2,
                    fill: false,
                    borderColor: "rgba(220,53,69,0.9)",
                    pointRadius: 2
                },
                {
                    label: "Revenue (‚Ç¨)",
                    data: revenueSeries,
                    yAxisID: "y1",
                    tension: 0.3,
                    borderWidth: 2,
                    fill: false,
                    borderColor: "rgba(25,135,84,0.9)",
                    pointRadius: 2
                },
                {
                    label: "Veicoli effett. noleggiati",
                    data: vehiclesSeries,
                    yAxisID: "y",
                    tension: 0.3,
                    borderWidth: 2,
                    fill: false,
                    borderColor: "rgba(255,193,7,0.9)",
                    pointRadius: 2
                }
            ]
        };

        const config = {
            type: "line",
            data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: "index",
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || "";
                                const value = context.parsed.y;
                                if (label.includes("‚Ç¨")) {
                                    return label + ": " + formatCurrency(value);
                                }
                                return label + ": " + formatNumber(value, 0);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: false
                        }
                    },
                    y: {
                        type: "linear",
                        position: "left",
                        title: {
                            display: true,
                            text: "Veicoli / Noleggi"
                        },
                        beginAtZero: true
                    },
                    y1: {
                        type: "linear",
                        position: "right",
                        title: {
                            display: true,
                            text: "Euro (‚Ç¨)"
                        },
                        beginAtZero: true,
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            }
        };

        if (chartInstance) {
            chartInstance.destroy();
        }
        chartInstance = new Chart(ctx, config);
    }

    // =========================
    // CSV EXPORT
    // =========================

    function downloadFilteredCsv(currentData) {
        const bookings = currentData.bookings;

        const rows = [];
        rows.push([
            "Data",
            "Anno",
            "Mese",
            "Gruppo",
            "Stazione",
            "Acquisizione",
            "Duration",
            "Price"
        ]);

        for (const b of bookings) {
            if (!b.date) continue;
            const dateStr = b.date.toISOString().slice(0, 10);
            rows.push([
                dateStr,
                b.year,
                b.month,
                (b.groupLabel || "").replace(/;/g, ","),
                (b.station || "").replace(/;/g, ","),
                (b.acquisition || "").replace(/;/g, ","),
                b.duration || 0,
                b.price || 0
            ]);
        }

        let csvContent = "";
        rows.forEach((row, idx) => {
            const line = row.map(v => {
                if (v == null) return "";
                const s = String(v);
                if (s.includes(",") || s.includes(";") || s.includes('"')) {
                    return '"' + s.replace(/"/g, '""') + '"';
                }
                return s;
            }).join(";");
            csvContent += line + (idx < rows.length - 1 ? "\n" : "");
        });

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "dati_filtrati_prenotazioni.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // =========================
    // GESTIONE FILTRI & REFRESH
    // =========================

    function getFiltersFromUI() {
        const yearFilter = document.getElementById("yearFilter");
        const monthFilter = document.getElementById("monthFilter");
        const groupFilter = document.getElementById("groupFilter");
        const tipologiaFilterEl = document.getElementById("tipologiaFilter");
        const acquisitionFilter = document.getElementById("acquisitionFilter");
        const stationFilter = document.getElementById("stationFilter");

        const filters = {
            yearsSelected: getSelectedValues(yearFilter),
            monthsSelected: getSelectedValues(monthFilter),
            groupsSelected: getSelectedValues(groupFilter),
            acquisitionsSelected: getSelectedValues(acquisitionFilter),
            stationsSelected: getSelectedValues(stationFilter),
            tipologieSelected: tipologiaFilterEl && tipologiaFilterEl.offsetParent !== null
                ? getSelectedValues(tipologiaFilterEl)
                : new Set()
        };

        return filters;
    }

    function refreshDashboard() {
        const filters = getFiltersFromUI();
        const ranges = getCurrentAndPreviousRanges(filters);

        const currentData = filterDataForRange(ranges.current, filters, true, false);
        const previousData = ranges.previous
            ? filterDataForRange(ranges.previous, filters, false, true)
            : { fleet: [], bookings: [] };

        updateKpis(currentData, previousData, ranges, filters);
        updateChart(currentData, ranges);

        return { currentData, previousData, ranges, filters };
    }

    // =========================
    // INIZIALIZZAZIONE FILTRI (LISTE)
    // =========================

    function initFiltersLists() {
        // Stazioni
        const stationFilter = document.getElementById("stationFilter");
        stationFilter.innerHTML = "";
        const sortedStations = Array.from(stationsList).sort((a, b) =>
            a.localeCompare(b, "it", { sensitivity: "base" })
        );
        sortedStations.forEach(st => {
            const opt = document.createElement("option");
            opt.value = st;
            opt.textContent = st;
            opt.selected = true;
            stationFilter.appendChild(opt);
        });

        // Acquisizioni
        const acquisitionFilter = document.getElementById("acquisitionFilter");
        acquisitionFilter.innerHTML = "";
        const sortedAcq = Array.from(acquisitionList).sort((a, b) =>
            a.localeCompare(b, "it", { sensitivity: "base" })
        );
        sortedAcq.forEach(acq => {
            const opt = document.createElement("option");
            opt.value = acq;
            opt.textContent = acq;
            opt.selected = true;
            acquisitionFilter.appendChild(opt);
        });

        // Tipologia (se presente)
        const tipContainer = document.getElementById("tipologiaFilterContainer");
        const tipFilter = document.getElementById("tipologiaFilter");
        if (tipologiaList.size > 0) {
            tipFilter.innerHTML = "";
            const sortedTip = Array.from(tipologiaList).sort((a, b) =>
                a.localeCompare(b, "it", { sensitivity: "base" })
            );
            sortedTip.forEach(t => {
                const opt = document.createElement("option");
                opt.value = t;
                opt.textContent = t;
                opt.selected = true;
                tipFilter.appendChild(opt);
            });
            tipContainer.style.display = "block";
        } else {
            tipContainer.style.display = "none";
        }

        // Anno/mese/gruppo: selezioniamo tutto di default
        setAllOptionsSelected(document.getElementById("yearFilter"), true);
        setAllOptionsSelected(document.getElementById("monthFilter"), true);
        setAllOptionsSelected(document.getElementById("groupFilter"), true);
    }

    function attachFilterEvents() {
        const selects = document.querySelectorAll(".filter-select");
        selects.forEach(sel => {
            sel.addEventListener("change", () => {
                refreshDashboard();
            });
        });

        const projectionSelect = document.getElementById("projectionSelect");
        projectionSelect.addEventListener("change", () => {
            const factor = parseFloat(projectionSelect.value) || 0.1;
            generateAllBookings(factor);
            refreshDashboard();
        });

        const clearBtn = document.getElementById("clearFiltersBtn");
        clearBtn.addEventListener("click", () => {
            // reset multi-selects
            const yearFilter = document.getElementById("yearFilter");
            const monthFilter = document.getElementById("monthFilter");
            const groupFilter = document.getElementById("groupFilter");
            const acquisitionFilter = document.getElementById("acquisitionFilter");
            const stationFilter = document.getElementById("stationFilter");
            const tipFilter = document.getElementById("tipologiaFilter");

            [yearFilter, monthFilter, groupFilter, acquisitionFilter, stationFilter, tipFilter].forEach(sel => {
                if (sel) setAllOptionsSelected(sel, true);
            });

            const projectionSelect = document.getElementById("projectionSelect");
            projectionSelect.value = "0.10";
            generateAllBookings(0.10);
            refreshDashboard();
        });

        const printBtn = document.getElementById("printBtn");
        printBtn.addEventListener("click", () => {
            window.print();
        });

        const csvBtn = document.getElementById("downloadCsvBtn");
        csvBtn.addEventListener("click", () => {
            const { currentData } = refreshDashboard();
            downloadFilteredCsv(currentData);
        });
    }

    // =========================
    // FETCH & INIT
    // =========================

    async function initDashboard() {
        try {
            const [
                fleetRes,
                stationRes,
                bookingsRes,
                bookingsJanRes
            ] = await Promise.all([
                fetch("fleetData_clean.json"),
                fetch("fleetStations2025.json"),
                fetch("bookings2025.json"),
                fetch("bookingsJan2026.json")
            ]);

            const [fleetJson, stationJson, bookingsJson, bookingsJanJson] = await Promise.all([
                fleetRes.json(),
                stationRes.json(),
                bookingsRes.json(),
                bookingsJanRes.json()
            ]);

            // Normalizza flotta
            fleetData = normalizeFleetData(fleetJson || []);

            // Stazioni da fleetStations2025.json (solo per arricchire stationsList)
            if (Array.isArray(stationJson)) {
                const sampleS = stationJson[0] || {};
                const stationField = detectFieldName(sampleS, ["stazione", "station", "location"]);
                if (stationField) {
                    stationJson.forEach(row => {
                        const st = (row[stationField] || "").toString().trim();
                        if (st) stationsList.add(st);
                    });
                }
            }

            // Normalizza prenotazioni
            baseBookings2025 = normalizeBookings(bookingsJson || [], false);
            jan2026Bookings = normalizeBookings(bookingsJanJson || [], true);

            // Proiezioni iniziali (10%)
            generateAllBookings(0.10);

            // Inizializza liste filtri
            initFiltersLists();

            // Aggancia eventi
            attachFilterEvents();

            // Primo render
            refreshDashboard();

        } catch (err) {
            console.error("Errore nel caricamento dei dati:", err);
            alert("Errore nel caricamento dei dati. Verifica i file JSON nella root del repository.");
        }
    }

    document.addEventListener("DOMContentLoaded", initDashboard);
</script>
</body>
</html>
